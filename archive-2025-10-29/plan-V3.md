# ğŸ’­ é—®é¢˜åˆ†æä¸æ‰§è¡Œç­–ç•¥

> **æ ¸å¿ƒæ€è€ƒ**ï¼šæˆ‘è§‰å¾—è¿™ä¸ªæ¡†æ¶å·²ç»æ­å¥½äº†ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºè¿™ä¸‰ä¸ªé—®é¢˜å’Œå®ƒä»¬çš„è§£å†³æˆ‘ä»¬è¿˜æ²¡æœ‰å®Œå…¨åœ°åšå¥½ã€‚å°±æ˜¯è¯´æˆ‘æƒ³å…ˆè§£å†³æœ€ç®€å•çš„è¿™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æœ€åè¿™ä¸ªåç§»çš„é—®é¢˜ï¼Œå°±æ˜¯è¿™ä¸ªdriftçš„é—®é¢˜ã€‚ç„¶åå†è§£å†³ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œä½ è§‰å¾—è¿™ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯å¥½ï¼Ÿå› ä¸ºæˆ‘æœ€åæ˜¯æƒ³ä»ç®€å•åˆ°éš¾å¼€å§‹ï¼Œä»ä¸€ä¸ªå®è·µçš„é¡ºåºæ¥è¯´ï¼Œæˆ‘æ˜¯æƒ³å…ˆè§£å†³ä¸€ä¸ªç®€å•çš„é—®é¢˜ï¼Œç„¶åå†è§£å†³å…¶ä»–çš„å¤æ‚çš„é—®é¢˜ã€‚
>
> æˆ‘æ„Ÿè§‰ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯æœ‰ä¸€ä¸ªæ•°æ®ä¹‹åï¼Œæˆ‘ä»¬åˆ¤æ–­è¿™ä¸ªAIå®ƒæ˜¯ä¸æ˜¯åç§»äº†ã€‚è¿™ä¸ªæ•°æ®æ˜¯å…¶ä»–ä¸¤ä¸ªé—®é¢˜çš„å…ˆé©±ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰è¿™ä¸ªæ•°æ®çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æ³•matchè¿™ä¸ªåŒ¹é…åº¦ï¼Œå¯¹å§ï¼Ÿæˆ‘ä»¬ä¹Ÿæ²¡æœ‰åŠæ³•åšè¿™ä¸ªå¤ç”¨çš„æƒ…å†µï¼Œlearning from experienceçš„æƒ…å†µã€‚Q2å’ŒQ3å…¶å®å–å†³äºQ1ï¼Œè¿™æ˜¯æˆ‘çš„ç†è§£ã€‚æ‰€ä»¥æˆ‘æƒ³å…ˆåšQ1ï¼Œå†åšQ2ï¼Œå†åšQ3ï¼Œä¸çŸ¥é“ä½ åŒæ„è¿™ä¸ªæ–¹æ¡ˆå—ï¼Ÿæˆ‘è§‰å¾—å¤§ä½“æ¡†æ¶æ˜¯æœ‰çš„ï¼Œæˆ‘ä»¬ç°åœ¨å°±è¦èµ°ä¸€éç»†èŠ‚ã€‚
>
> **æŠ€æœ¯ç»†èŠ‚éœ€è¦ç»†åŒ–**ï¼šä¸¾ä¸ªä¾‹å­æ¯”å¦‚Q1çš„å››ä¸ªå®ˆå«+è®¡ç®—scoreçš„æ–¹å¼+æ•°æ®input/outputéƒ½å¯ä»¥ç»§ç»­ç»†åŒ–ï¼ˆæ˜¯å¦è¦å®šä¸€ä¸ªts oræ•°æ®åº“ç»“æ„ï¼Œæšä¸¾ç»“æ„ï¼‰ï¼ŒQ2çš„patternçš„å®šä¹‰ï¼ˆè¿™äº›å¦‚ä½•å®šä¹‰ï¼šç»éªŒæ— æ³•æ²‰æ·€ä¸è¿ç§»ï¼Œé€ æˆé‡å¤åŠ³åŠ¨ï¼Œæ˜¯å¦è¦å®šä¸€ä¸ªts oræ•°æ®åº“ç»“æ„ï¼Œæšä¸¾ç»“æ„ï¼‰ï¼ŒQ3çš„"ç”¨æˆ·æ°´å¹³ Ã— ä»»åŠ¡éš¾åº¦" è¿™ä¸¤ä¸ªä¹Ÿå¯ä»¥å®šä¹‰ï¼Œæ˜¯å¦è¦å®šä¸€ä¸ªts oræ•°æ®åº“ç»“æ„ï¼Œæšä¸¾ç»“æ„ï¼‰
>
> è¿™æ˜¯æˆ‘çš„æƒ³æ³•

## âœ… æ‰§è¡Œç­–ç•¥ç¡®è®¤

æˆ‘å®Œå…¨åŒæ„ä½ çš„æ‰§è¡Œé¡ºåºï¼šå…ˆæ‰“ç©¿ Q1ï¼ˆåèˆªæ£€æµ‹ï¼‰â†’ å†åš Q2ï¼ˆæ¨¡å¼å¤ç”¨ï¼‰â†’ æœ€å Q3ï¼ˆåŠ¨æ€æŠ½è±¡ï¼‰ã€‚

ç†ç”±å¾ˆç®€å•ä¹Ÿå¾ˆå·¥ç¨‹åŒ–ï¼šQ1 äº§å‡ºçš„"è§„èŒƒåŒ–äº‹ä»¶ + å®ˆå«åˆ†æ•°"å°±æ˜¯ Q2 æŠ½å¡ä¸ Q3 è·¯ç”±çš„è®­ç»ƒ/æ£€ç´¢æ•°æ®ã€‚æ²¡æœ‰ Q1ï¼Œå°±æ²¡æœ‰å¯å¤ç”¨çš„"äº‹å®è¯­æ–™åº“"ã€‚

ä¸‹é¢æˆ‘æŠŠä¸‰å—ä¸€æ¬¡æ€§è®²æ¸…æ¥šï¼šå…ˆç»™ä½ å®ç°é¡ºåºä¸éªŒæ”¶æ ‡å‡†ï¼Œç„¶åç»™ç²¾ç¡®çš„æ•°æ®ç»“æ„ï¼ˆTypeScript + å¯é€‰ SQLite DDLï¼‰ä¸ç®—æ³•ç»†èŠ‚ï¼Œæœ€åç»™ç«¯åˆ°ç«¯ç¤ºä¾‹ï¼ˆå’Œä½ å½“å‰"ç¿»è¯‘ README å´è¯¯æ”¹ requirements.txt"çš„ä¾‹å­å®Œå…¨å¯¹é½ï¼‰ã€‚

---

## ğŸ“‹ ä¸€ã€å®æ–½é¡ºåºï¼ˆä»ç®€å•åˆ°éš¾ï¼‰

### Phase 1ï¼ˆQ1ï¼šåèˆªæ£€æµ‹ï¼ŒP0ï¼‰

**ç›®æ ‡**ï¼šå¯¹ä»»æ„ä¸€æ¬¡ä¼šè¯/æäº¤ï¼Œè¾“å‡ºäº‹ä»¶æµä¸ drift è¯„åˆ†ï¼Œå¹¶èƒ½å‘Šè­¦/å›æ»šã€‚

**äº¤ä»˜ç‰©**ï¼š
1. `events.jsonl`ï¼ˆæ¥è‡ª patch.diff/term.log çš„è§„èŒƒåŒ–äº‹ä»¶ï¼‰
2. `guards.jsonl`ï¼ˆå››å®ˆå« + drift_score + actionï¼‰
3. "æœ€å° UI/CLI"ï¼šåˆ—å‡ºé«˜åˆ†äº‹ä»¶ã€æ˜¾ç¤ºåŸå› ã€æä¾›å›æ»šå‘½ä»¤

**éªŒæ”¶**ï¼š
- â‰¥95% çš„è¶Šç•Œæ”¹åŠ¨ï¼ˆä¸åœ¨ allowed_pathsï¼‰è¢«æ£€å‡º
- å‡é˜³æ€§ â‰¤10%ï¼ˆå¯é€šè¿‡ä¾‹å¤–æœºåˆ¶é€æ­¥ä¸‹é™ï¼‰

### Phase 2ï¼ˆQ2ï¼šæ¨¡å¼å¤ç”¨ï¼ŒP1ï¼‰

**ç›®æ ‡**ï¼šæŠŠ"åšæˆçš„ç»å†"æ²‰æ·€æˆæ¨¡å¼å¡ï¼Œèƒ½åœ¨æ–°ä»»åŠ¡è‡ªåŠ¨æ£€ç´¢è§¦å‘ã€‚

**äº¤ä»˜ç‰©**ï¼š
1. `patterns/pc_*.json`ï¼ˆä»å¤šä¸ª runs æŠ½å–ï¼‰
2. æ£€ç´¢ä¸æ³¨å…¥ï¼šç»™å®š objective/issue_text â†’ è¿”å›å‘½ä¸­çš„æ¨¡å¼å¡ï¼ˆå«ä¸¤æ¡£è§†å›¾çš„æ–‡æ¡ˆéª¨æ¶ï¼‰

**éªŒæ”¶**ï¼š
- æ¨¡å¼å¤ç”¨ç‡â†‘ã€é¦–è¯•æˆåŠŸç‡â†‘ã€å¹³å‡å›åˆæ•°â†“ï¼ˆä»¥å° A/B éªŒè¯ï¼‰

### Phase 3ï¼ˆQ3ï¼šåŠ¨æ€æŠ½è±¡ï¼ŒP1ï¼‰

**ç›®æ ‡**ï¼šåŒä¸€å¡ä¸¤æ¡£è§†å›¾ï¼ŒæŒ‰"ç”¨æˆ·æ°´å¹³ Ã— ä»»åŠ¡éš¾åº¦"è‡ªåŠ¨è·¯ç”±ã€‚

**äº¤ä»˜ç‰©**ï¼š
1. `profiles/<user>.json`ï¼ˆç”»åƒï¼‰
2. è·¯ç”±å™¨ï¼šæ ¹æ®ç”»åƒä¸ä»»åŠ¡éš¾åº¦ï¼Œè¾“å‡º terse | guided

**éªŒæ”¶**ï¼š
- æ–°æ‰‹åœ¨ guided ä¸‹æˆåŠŸç‡/ç¨³å®šæ€§æ›´é«˜ï¼›ä¸“å®¶åœ¨ terse ä¸‹ä¸ä¸­æ–­

---

## ğŸ”§ äºŒã€æ•°æ®ä¸æ¥å£è§„èŒƒï¼ˆTS + JSONL + å¯é€‰ SQLiteï¼‰

### 0) å…±åŒæšä¸¾

```typescript
// phases/checkpoints
export type Phase = 'reproduce' | 'modify' | 'test' | 'regress';

// toolsï¼ˆæ–°å¢ plan ç±»å‹ï¼‰
export type Tool = 'edit' | 'shell' | 'browse' | 'plan';

// guard action
export type GuardAction = 'ok' | 'warn' | 'rollback';

// user level & task difficulty
export type UserLevel = 'novice' | 'intermediate' | 'expert';
export type TaskDifficulty = 'low' | 'medium' | 'high';

// confidence levelsï¼ˆChat-only ç”¨ï¼‰
export type Confidence = 'low' | 'medium' | 'high';
```

---

### 1) Q1ï¼šè¾“å…¥/è¾“å‡ºä¸ç®—æ³•

#### 1.1 ç›®æ ‡å®šä¹‰ï¼ˆgoal.jsonï¼‰

```typescript
export interface GoalConfig {
  run_id: string;
  objective: string;                         // e.g., "Translate README.md to Chinese"
  allowed_paths: string[];                   // allow-list (prefix match)
  forbidden_paths?: string[];                // optional block-list
  checkpoints: Phase[];                      // ["reproduce","modify","test","regress"]
  required_tests?: string[];                 // names/regex you expect to run/ pass
  allowed_tools_by_phase?: Partial<Record<Phase, Tool[]>>; // default è§ä¸‹
  thresholds?: { warn: number; rollback: number };         // default 0.5/0.8
  meta?: Record<string, any>;                // ä»»æ„æ‰©å±•
}
```

**é»˜è®¤ç­–ç•¥**ï¼ˆè‹¥ allowed_tools_by_phase æœªç»™å‡ºï¼‰ï¼š
- reproduce: ['shell','browse']
- modify:    ['edit','shell']
- test:      ['shell']
- regress:   ['shell']

**é»˜è®¤é˜ˆå€¼**ï¼šwarn=0.5ï¼Œrollback=0.8

#### 1.2 äº‹ä»¶ï¼ˆevents.jsonlï¼‰

```typescript
export interface BaseEvent {
  id: string;                 // uuid
  run_id: string;
  step: number;               // 1,2,3...
  ts?: string;                // ISO time
  phase: Phase;
  tool: Tool;
  why?: string;               // rationale in short
  evidence?: {
    tests?: string[];         // tests names/assertions referenced
    logs?: string[];          // log lines digests or links
    links?: string[];         // issue/PR/docs links
  };
}

export interface EditEvent extends BaseEvent {
  tool: 'edit';
  where: { path: string; start?: number; end?: number };
  what: { diff?: string; ast_hint?: string };
}

export interface PlanEvent extends BaseEvent {
  tool: 'plan';
  where: { path: string; start?: number; end?: number };
  confidence?: Confidence;  // Chat-only æå–çš„ç½®ä¿¡åº¦
}

export interface ShellEvent extends BaseEvent {
  tool: 'shell';
  cmd: string;
  exit_code?: number;
  stdout_digest?: string;     // hash/first-N lines
}

export type Event = EditEvent | PlanEvent | ShellEvent;
```

**JSONL ç¤ºä¾‹**ï¼ˆDiff è·¯çº¿ï¼‰ï¼š

```json
{"id":"e1","run_id":"r42","step":1,"phase":"modify","tool":"edit","where":{"path":"README.md"},"what":{"diff":"(hunk)"},"why":"from patch.diff"}
{"id":"e2","run_id":"r42","step":2,"phase":"modify","tool":"edit","where":{"path":"requirements.txt"},"what":{"diff":"(hunk)"}}
{"id":"e3","run_id":"r42","step":3,"phase":"test","tool":"shell","cmd":"pytest -k doc_lang_check"}
{"id":"e4","run_id":"r42","step":4,"phase":"test","tool":"shell","cmd":"pytest -k whitelist_diff_check"}
```

**Chat-only ç¤ºä¾‹**ï¼š

```json
{"id":"p1","run_id":"r60","step":1,"phase":"modify","tool":"plan","where":{"path":"README.md"},"why":"è®¡åˆ’ç¿»è¯‘ README.md","confidence":"medium"}
{"id":"e2","run_id":"r60","step":2,"phase":"modify","tool":"edit","where":{"path":"README.md"},"why":"å·²å°†è‹±æ–‡å†…å®¹æ”¹ä¸ºä¸­æ–‡","confidence":"high"}
{"id":"t1001","run_id":"r60","step":1001,"phase":"test","tool":"shell","cmd":"pytest -k doc_lang_check"}
```

#### 1.3 å®ˆå«è¾“å‡ºï¼ˆguards.jsonlï¼‰

```typescript
export interface GuardScores {
  id: string;                 // match event id
  run_id: string;
  step: number;
  scope_guard: number;        // 0~1
  plan_guard: number;         // 0~1
  test_guard: number;         // 0~1
  evidence_guard: number;     // 0~1
  drift_score: number;        // weighted sum
  action: GuardAction;        // ok | warn | rollback
  file?: string;              // for edit events
  notes?: string;             // reason for flag
}
```

**æ‰“åˆ†ç®—æ³•**ï¼ˆå¯ç›´æ¥è½åœ°ï¼‰ï¼š

```typescript
// æƒé‡ï¼ˆå¯é…ç½®ï¼‰
const W = { scope: 0.4, plan: 0.3, test: 0.2, evidence: 0.1 };

// é‡è¦ï¼šä»…å¯¹ tool=edit è®¡åˆ†ï¼Œtool=plan æ’ action=ok
if (event.tool === 'plan') {
  return { scope_guard: 0, plan_guard: 0, test_guard: 0, evidence_guard: 0, 
           drift_score: 0, action: 'ok' };
}

// ScopeGuardï¼šç¼–è¾‘æ˜¯å¦è¶Šç•Œï¼ˆprefix allow-listï¼‰
scope_guard = (event.tool==='edit')
  ? (inAllowed(event.where.path, goal.allowed_paths) ? 0 : 1)
  : 0;

// PlanGuardï¼šæ­¤ phase æ˜¯å¦å…è®¸æ­¤ tool/æ­¤è·¯å¾„ç±»åˆ«
plan_guard = (() => {
  const allowTools = goal.allowed_tools_by_phase?.[event.phase] || defaultTools[event.phase];
  if (!allowTools.includes(event.tool)) return 1;
  if (event.tool==='edit' && !inAllowed(event.where.path, goal.allowed_paths)) return 1;
  return 0;
})();

// TestGuardï¼šè‹¥ phase æ˜¯ test/regressï¼Œæ˜¯å¦è·‘äº†/é€šè¿‡äº† required_tests
// MVPï¼šçœ‹åˆ°ç›¸åº” pytest å‘½ä»¤åˆ™ 0ï¼Œå¦åˆ™ 1ï¼ˆæˆ–ç»“åˆ term.log è§£æé€šè¿‡ç‡ï¼‰
test_guard = ((event.phase==='test' || event.phase==='regress') && event.tool==='shell')
  ? (coversRequired(event.cmd, goal.required_tests) ? 0 : 1)
  : 0;

// EvidenceGuardï¼šmodify é˜¶æ®µçš„ edit äº‹ä»¶ï¼Œæ˜¯å¦å¸¦æœ‰ tests/logs/links ä½œä¸ºè¯æ®
evidence_guard = (event.phase==='modify' && event.tool==='edit')
  ? (event.evidence && (event.evidence.tests?.length || event.evidence.logs?.length || event.evidence.links?.length) ? 0 : 0.5)
  : 0;

// ç»¼åˆï¼š
drift_score = W.scope*scope_guard + W.plan*plan_guard + W.test*test_guard + W.evidence*evidence_guard;

// åŠ¨ä½œï¼š
action = (drift_score >= (goal.thresholds?.rollback ?? 0.8)) ? 'rollback'
       : (drift_score >= (goal.thresholds?.warn ?? 0.5))     ? 'warn'
       : 'ok';
```

**JSONL ç¤ºä¾‹**ï¼š

```json
{"id":"e1","run_id":"r42","step":1,"scope_guard":0,"plan_guard":0,"test_guard":0,"evidence_guard":0,"drift_score":0,"action":"ok","file":"README.md"}
{"id":"e2","run_id":"r42","step":2,"scope_guard":1,"plan_guard":1,"test_guard":0,"evidence_guard":0.5,"drift_score":0.85,"action":"warn","file":"requirements.txt","notes":"not in allowed_paths"}
{"id":"p1","run_id":"r60","step":1,"scope_guard":0,"plan_guard":0,"test_guard":0,"evidence_guard":0,"drift_score":0,"action":"ok","file":"README.md","notes":"plan event, not scored"}
```

**Q1 çš„è¯„æµ‹**ï¼š
- æ£€å‡ºç‡ï¼ˆçœŸæ­£ä¾‹ / å…¨éƒ¨åèˆªï¼‰
- è¯¯æŠ¥ç‡ï¼ˆå‡æ­£ä¾‹ / å…¨éƒ¨å‘Šè­¦ï¼‰
- åèˆªæ¢å¤æ—¶é—´ï¼ˆé¦–æ¬¡ warn â†’ å›åˆ°æ­£ç¡® checkpoint çš„æ­¥æ•°/ç§’ï¼‰
- è¦†ç›–é¢ï¼ˆè¢«å®ˆå«è¦†ç›–çš„åèˆªç±»å‹å æ¯”ï¼šè·¯å¾„è¶Šç•Œ/é”™è¯¯ phase/æœªè·‘æµ‹è¯•/æ— è¯æ®ï¼‰

---

### 2) Q2ï¼šæ¨¡å¼å¡å®šä¹‰ä¸æ£€ç´¢ï¼ˆåœ¨ Q1 æ‰“å¥½ååšï¼‰

#### 2.1 æ¨¡å¼å¡ï¼ˆpatterns/pc_*.jsonï¼‰

```typescript
export interface PatternCard {
  version: string;                     // e.g., "1.0"
  pattern_id: string;                  // "pc_doc_only_change"
  title: string;                       // äººç±»å¯è¯»æ ‡é¢˜
  triggers: string[];                  // æ£€ç´¢å…³é”®è¯/æ­£åˆ™
  steps: string[];                     // å…³é”®æ­¥éª¤ï¼ˆå¯ç”¨äºè®¡åˆ’/æç¤ºï¼‰
  invariants: string[];                // ä¸å˜é‡ï¼ˆå¿…é¡»æˆç«‹çš„çº¦æŸï¼‰
  anti_patterns?: string[];            // ç¦æ­¢æˆ–å¸¸è§è¯¯ç”¨
  eval_examples?: string[];            // ç›¸å…³æµ‹è¯•/éªŒè¯å
  risks?: string[];                    // é£é™©æç¤ºï¼ˆä½•æ—¶éœ€è¦å‡çº§å®¡æ ¸/ä¾‹å¤–ï¼‰
  views: {                             // Q3 ç”¨
    terse: string;                     // ä¸“å®¶ç‰ˆ
    guided: string;                    // æ–°æ‰‹ç‰ˆ
  };
  provenance: {                        // æº¯æº
    source_runs: string[];             // ["r42","r51"...]
    created_by: string;                // user id
    created_at: string;
  };
  metrics?: {                          // å¯é€‰ï¼šè¿™å¼ å¡å¸¦æ¥çš„ uplift è®°å½•
    reuse_count: number;
    first_try_uplift?: number;
  };
}
```

**æœ€å°æ£€ç´¢æ‰“åˆ†**ï¼ˆå…ˆè§„åˆ™ + å…³é”®è¯è¦†ç›–ï¼›åç»­å¯æ¥å‘é‡ï¼‰ï¼š

```typescript
score = hits(triggers, goal.objective + issue_text) / triggers.length
// å†²çªé™æƒï¼šè‹¥å¡çš„ invariants ä¸ goal.allowed_paths/forbidden_paths å†²çªï¼Œscore -= 0.3
// é˜¶æ®µæ€§åŠ æƒï¼šè‹¥ Q1 çš„å®ˆå«å‘Šè­¦ç±»å‹ä¸å¡çš„ anti_patterns ç›¸ç¬¦ï¼Œä¼˜å…ˆçº§â†‘
```

**æ²‰æ·€ç­–ç•¥**ï¼š
- è§¦å‘æ¡ä»¶ï¼šæœ¬æ¬¡ run é€šè¿‡éªŒè¯ï¼ˆæˆ–äººå·¥ç¡®è®¤"åšå¯¹äº†"ï¼‰
- åˆå¹¶ï¼šå¤š run åŒç±»å¡å¯åˆå¹¶ï¼ˆå¹¶ä¿ç•™ source_runs åˆ—è¡¨ï¼‰
- è¿›å…¥åº“æ ‡å‡†ï¼šèƒ½å¸¦æ¥æ˜æ˜¾ upliftï¼ˆé¦–è¯•æˆåŠŸç‡/å›åˆæ•°/æ—¶é—´ï¼‰æ‰çº³å…¥å›¢é˜Ÿåº“

---

### 3) Q3ï¼šç”»åƒä¸è·¯ç”±

#### 3.1 ç”¨æˆ·ç”»åƒï¼ˆprofiles/*.jsonï¼‰

```typescript
export interface UserProfile {
  user_id: string;
  self_report: UserLevel;                // è‡ªæŠ¥æ°´å¹³
  hist_first_try_success: number;        // 0~1
  pref?: 'guided' | 'terse';             // æ˜ç¤ºåå¥½ï¼ˆå¯è¦†ç›–è‡ªåŠ¨è·¯ç”±ï¼‰
  notes?: string;
}
```

#### 3.2 ä»»åŠ¡éš¾åº¦ä¼°è®¡ï¼ˆæ— éœ€å®Œç¾ï¼Œå…ˆå¯å‘å¼ï¼‰

```typescript
export interface TaskDescriptor {
  files_touched_est?: number;    // é¢„ä¼°ä¿®æ”¹æ–‡ä»¶æ•°
  loc_delta_est?: number;        // é¢„ä¼°å˜æ›´è¡Œæ•°
  repo_familiarity?: number;     // 0~1ï¼ˆæŒ‰è´¡çŒ®/æœ€è¿‘äº’åŠ¨/æ–‡ä»¶ç›¸ä¼¼åº¦ï¼‰
  risk_flags?: string[];         // e.g., ["dependency","security","db-migration"]
}

function estimateDifficulty(d: TaskDescriptor): TaskDifficulty {
  const score = (d.files_touched_est||0)/5 + (d.loc_delta_est||0)/200 + (1-(d.repo_familiarity||0));
  if (score < 0.8) return 'low';
  if (score < 1.6) return 'medium';
  return 'high';
}
```

#### 3.3 è§†å›¾è·¯ç”±ï¼ˆMVPï¼‰

```typescript
function chooseView(profile: UserProfile, task: TaskDescriptor): 'guided'|'terse' {
  const diff = estimateDifficulty(task);
  if (profile.pref) return profile.pref;
  if (profile.self_report === 'novice') return 'guided';
  if (diff === 'high') return 'guided';
  if (profile.hist_first_try_success < 0.5) return 'guided';
  return 'terse';
}
```


---

### 4) å¯é€‰æ•°æ®åº“ï¼ˆSQLite DDLï¼Œå ä½å¯åç½®ï¼‰

JSONL å…ˆè·‘é€šï¼ŒSQLite ä¾¿äºåšç»Ÿè®¡/æŠ¥è¡¨/å¤šç”¨æˆ·åä½œã€‚

```sql
-- runs
CREATE TABLE runs (
  run_id TEXT PRIMARY KEY,
  created_at TEXT,
  objective TEXT
);

-- goals
CREATE TABLE goals (
  run_id TEXT,
  content JSON,
  PRIMARY KEY(run_id)
);

-- events
CREATE TABLE events (
  id TEXT PRIMARY KEY,
  run_id TEXT,
  step INTEGER,
  ts TEXT,
  phase TEXT,
  tool TEXT,
  path TEXT,
  cmd TEXT,
  payload JSON
);

-- guards
CREATE TABLE guard_scores (
  id TEXT PRIMARY KEY,
  run_id TEXT,
  step INTEGER,
  scope REAL, plan REAL, test REAL, evidence REAL,
  drift REAL, action TEXT, file TEXT, notes TEXT
);

-- patterns
CREATE TABLE patterns (
  pattern_id TEXT PRIMARY KEY,
  version TEXT,
  title TEXT,
  content JSON,
  reuse_count INTEGER DEFAULT 0
);

-- profiles
CREATE TABLE profiles (
  user_id TEXT PRIMARY KEY,
  content JSON
);
```

---

## ğŸš€ ä¸‰ã€ç«¯åˆ°ç«¯ï¼ˆä»¥ä½ çš„"æ–‡æ¡£ä»»åŠ¡è·‘é¢˜"ä¸ºä¾‹ï¼‰

**è¾“å…¥**ï¼š
- `goal.json`ï¼šåªå…è®¸ README.md / docs/**
- `patch.diff`ï¼šæ”¹äº† README.md å¹¶è¯¯æ”¹ requirements.txt
- ï¼ˆå¯é€‰ï¼‰`term.log`ï¼šåŒ…å« pytest -k doc_lang_check ä¸ pytest -k whitelist_diff_check

**æ­¥éª¤**ï¼š
1. `patch2events` â†’ ç”Ÿæˆä¸¤æ¡ edit äº‹ä»¶ï¼ˆREADME.md / requirements.txtï¼‰
2. `term2events` â†’ ç”Ÿæˆä¸¤æ¡ shell äº‹ä»¶ï¼ˆæµ‹è¯•ï¼‰
3. `events2guards` â†’ å¯¹ requirements.txt ç»™å‡º Scope=1.0ï¼ŒPlan=1.0ï¼ŒEvidence=0.5 â†’ drift=0.85 â†’ action=warn
4. ï¼ˆé€šè¿‡/ç¡®è®¤åï¼‰æŠ½å¡ â†’ `pc_doc_only_change` å…¥åº“
5. æ–°ä»»åŠ¡"ç¿»è¯‘æ–‡æ¡£"å¯åŠ¨æ—¶ï¼Œæ£€ç´¢å‘½ä¸­è¯¥å¡ï¼š
   - terse ç»™ä¸“å®¶ï¼šç™½åå• + ç¦æ”¹ä¾èµ– + ä¸¤ä¸ªæ£€æŸ¥
   - guided ç»™æ–°æ‰‹ï¼šé€æ­¥é…ç½®ç™½åå•/è¯­è¨€æ£€æµ‹/ä¾‹å¤–æµç¨‹/å‘ç‚¹
6. åº¦é‡ï¼šç›¸ä¼¼ä»»åŠ¡åœ¨æœ‰å¡ vs æ— å¡ä¸‹ï¼Œæ¯”è¾ƒé¦–è¯•æˆåŠŸç‡/å›åˆæ•°/ç”¨æ—¶ï¼Œå‡º ablation å›¾ã€‚

---

## ğŸ› ï¸ å››ã€ä½ ä»Šå¤©å°±èƒ½æ¨è¿›çš„ç»†èŠ‚ï¼ˆQ1 æ‰“ç©¿ï¼‰

1. **æŠŠå››ä¸ªå®ˆå«å†™æˆçº¯å‡½æ•°**ï¼ˆæ–¹ä¾¿å•å…ƒæµ‹è¯•ï¼‰
   - `scopeGuard(e, goal) -> 0|1`
   - `planGuard(e, goal) -> 0|1`
   - `testGuard(e, goal, termLog?) -> 0|1`
   - `evidenceGuard(e) -> 0|0.5`
   - `driftScore(scores, weights, thresholds) -> {score, action}`

2. **å»ºç«‹ 8 ä¸ªæœ€å°å•æµ‹**
   - å…è®¸è·¯å¾„ç¼–è¾‘ / éå…è®¸è·¯å¾„ç¼–è¾‘
   - modify é˜¶æ®µä½¿ç”¨éæ³• tool
   - æµ‹è¯•åº”è·‘æœªè·‘ / å·²è·‘
   - æœ‰/æ—  evidence
   - **plan äº‹ä»¶æ’ action=okï¼ˆä¸è®¡åˆ†ï¼‰**
   - **Chat-only vs Diff è·¯çº¿ç­‰ä»·æ€§**
   - ç»¼åˆ case è§¦å‘ warn ä¸ rollback

3. **åšä¸€ä¸ª"ä¾‹å¤–æœºåˆ¶"**ï¼ˆæŠŠå‡é˜³æ€§é™ä¸‹æ¥ï¼‰
   - UI/CLIï¼š`ack --reason="éœ€è¦ä¸´æ—¶æ”¹ä¾èµ–ä»¥ä¿® build"`
   - ä¾‹å¤–å†™å…¥ `events.jsonl` çš„ `evidence.links/notes`ï¼Œä¸‹ä¸€æ¬¡å®ˆå«è§åˆ° æœ‰æ•ˆä¾‹å¤– å¯é™æƒ

4. **å·¥å…·é“¾éªŒè¯**
   - `tools/chat2events.py`ï¼šChat-only æå–å™¨ï¼ˆplanned vs appliedï¼‰
   - `tools/events2guards.py`ï¼šå››å®ˆå« + plan å¿½ç•¥ç­–ç•¥
   - `scripts/e2e_chat_only.py`ï¼šä¸€é”® Chat-only æµç¨‹

---

## ğŸ”— äº”ã€ä¸ºä½• Q1â†’Q2â†’Q3 æ˜¯æ­£ç¡®çš„ä¾èµ–å…³ç³»

- **Q1 è¾“å‡º = Q2/Q3 çš„è®­ç»ƒä¸æ£€ç´¢æ•°æ®**ï¼šæ²¡æœ‰ `events.jsonl` çš„"äº‹å®"ï¼Œæ¨¡å¼å¡åªèƒ½å‡­ç©ºæƒ³è±¡ã€‚
- **Q1 è¿˜èƒ½ç»™ Q2 æä¾›"anti_patterns/risks"**ï¼šå“ªäº›è¶Šç•Œæœ€å¸¸è§ï¼Ÿç›´æ¥å†™è¿›å¡ï¼Œä¸‹æ¬¡å…ˆå¤©è§„é¿ã€‚
- **Q3 çš„"éš¾åº¦ä¼°è®¡/è§†å›¾è·¯ç”±"éœ€è¦ Q1 çš„ç»Ÿè®¡**ï¼šå†å²é¦–è¯•æˆåŠŸç‡ã€åèˆªç‡ã€åèˆªæ¢å¤æ—¶é—´ â†’ ç”»åƒä¸è·¯ç”±çš„ä¾æ®ã€‚

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

å¦‚æœä½ è®¤å¯ä¸Šé¢çš„è§„èŒƒï¼Œæˆ‘å¯ä»¥æŠŠè¿™äº› TS æ¥å£ + å®ˆå«å‡½æ•°æ ·ä¾‹ç›´æ¥åˆå…¥ä½ ä»“åº“çš„ `types/` ä¸ `src/guards/`ï¼Œå¹¶åŠ ä¸Š8 æ¡å•æµ‹ï¼›ä½ å°±èƒ½é©¬ä¸Šè·‘ Phase 1 çš„ç«¯åˆ°ç«¯ï¼ˆä¸ä¾èµ–å¤–éƒ¨æ¨¡å‹ï¼‰ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬ç”¨ 3â€“5 æ¬¡çœŸå® run æŠ½å‡º ç¬¬ä¸€æ‰¹æ¨¡å¼å¡ï¼ˆQ2ï¼‰ï¼Œæœ€åå†æ¥ä¸Š è§†å›¾è·¯ç”±ï¼ˆQ3ï¼‰ã€‚