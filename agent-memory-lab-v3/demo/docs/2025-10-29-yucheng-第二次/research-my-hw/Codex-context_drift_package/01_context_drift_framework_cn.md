# Context Drift（语境/任务漂移）两阶段框架（中文）

## 1. 正式定义（Formal Definition）
**Context drift** 指在多轮交互或长时程任务中，智能体的行为逐步偏离最初的任务目标与约束，表现为随时间累积的偏移，而非单轮偶发错误。其本质是**目标一致性**与**任务语境**的稳定性被侵蚀。可从两类信号理解：
- **可观测行为信号**：动作/输出是否仍紧扣任务目标与约束（如是否在允许作用域内、是否继续推进子目标、是否陷入重复无效动作）。
- **内部模型信号**：模型表征/激活在注入新上下文后是否发生异常偏离（表征漂移），提示即将“跑题”。

> 区分：Context drift 偏重“任务/语境对齐”的逐步走偏；与“价值/安全对齐”的 policy/安全越狱问题相关但不等同。

## 2. 维度（Dimensions）概览
- **Wrong Scope / Scope Creep（作用域漂移）**：越出允许目标集合（文件/页面/字段/数据域等）。
- **Irrelevant Tool Use（工具无关/多余调用）**：与当前子目标无关的工具/API 调用，或高比例的空收益调用。
- **Repetitive Mistakes / Looping（重复错误/循环）**：无进展地重复同类动作/修复/点击。
- **Goal / Instruction Drift（目标/指令漂移）**：偏离初始目标或逐渐不再遵守指令/风格/格式等约束。
- **Safety / Jailbreak Drift（安全策略漂移）**：多轮逐步诱导下越过既定安全边界。
- **Context Loss / Reliability Drift（记忆/可靠性衰减）**：回合增多时准确性、覆盖度和一致性显著下降（例如对中段信息遗忘）。

## 3. 检测（Stage 1: Detection）
建议采用“可并行、与任务无关”的组合：
1) **激活差分探测（Activation-Delta）**：对比新上下文前/后层激活差分，训练轻量探测器（如线性探测）以判别是否发生任务/指令漂移。优点：不依赖生成文本，能作为旁路“看门狗”，并行运行。
2) **轨迹行为学**：
   - **作用域白名单**：所有读/写/点击目标需在允许集合内，越界即告警。
   - **循环/无进展检测**：n 步内重复同一动作或状态无变化，触发循环告警与早停候选。
   - **工具贡献率**：统计工具调用对目标状态推进的贡献，空收益/无关调用占比过高即告警。
   - **目标状态跟踪（UGST 等）**：维护结构化目标变量，若响应不再推进目标或违背约束，视为漂移。

**度量输出（示例）**：
- 作用域违规数/百步（或任务）；
- 无关工具调用占比、重复调用比、空收益率；
- 循环长度（连续无进展步数）与循环次数；
- 指令遵循/目标一致性随回合的曲线；
- 激活差分探测 AUC/TPR/FPR 与跨场景泛化。

## 4. 解决（Stage 2: Resolution）
- **提醒/再聚焦（Reminder/Refocus）**：注入简洁“目标/约束”提醒，常能显著降低漂移并拉回语境。
- **回滚（Rollback）**：对可逆副作用（代码/数据库/页面状态）从漂移点回退到安全检查点。
- **重规划（Re-plan）**：检测到循环/无进展后触发策略重构或切换替代方案（避免“死磕”）。
- **早停 + 人类介入**：严重漂移/长循环触发早停，提示人工复位或给出纠偏指令。
- **防漂移护栏（Preventive Guardrails）**：能力/角色/路径级约束（如目录写保护、API 许可列表、角色职责矩阵），将越界尝试在执行前拦截。

## 5. 基准映射（Instantiation）
- **SWE-bench（编码）**：以文件/函数为作用域单元；度量作用域违规、失败测试的重复修复次数、无效运行比例；在每次变更后跑测试并结合循环检测触发重规划/早停。
- **τ-Bench（工具对话）**：以结构化用户目标为锚点；统计“目标推进率”、无关 API 调用占比；UGST 约束响应生成，漂移时触发提醒或重询问澄清。
- **WebArena / WebShop（Web 导航）**：以页面/DOM 元素白名单为作用域；循环点击/页面震荡检测；度量“唯一页面/总点击”比、必要子任务完成率，必要时刷新/重定位或早停。

## 6. 评估设计
- **轨迹级标注**：抽样人工标注“漂移发生点”，评估探测器的精确率/召回率/延迟。
- **消融**：逐个关闭模块（作用域守护、循环早停、提醒等），测其对任务成功率/效率的影响。
- **跨基准泛化**：在编码/工具对话/Web 导航三类任务上复现实验，验证维度与算法的通用性。

---
**结论**：以“激活差分 + 行为轨迹”的检测组合，配合“提醒/回滚/重规划/早停/护栏”的分层干预，可构成面向长时程智能体的通用 Context Drift 监测与修复流水线，并可即插即用地部署到多类基准与真实系统中。
