# Q1 Demo: Four-Guard Goal Alignment System

å®Œæ•´çš„Q1ç«¯åˆ°ç«¯demoï¼Œæ¼”ç¤ºä»SWE-benchæ•°æ®åŠ è½½åˆ°Four-Guardç›‘æ§å†åˆ°è¯„ä¼°çš„å®Œæ•´æµç¨‹ã€‚

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
demo/
â”œâ”€â”€ steps/                    # âœ¨ UPDATED: æ ¸å¿ƒæ­¥éª¤æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ step1_load_data.py       # Step 1: æ•°æ®åŠ è½½ä¸è§£æ
â”‚   â”œâ”€â”€ step2_init_guards.py     # Step 2: Four-Guardåˆå§‹åŒ–ï¼ˆç§»é™¤LLMï¼‰
â”‚   â”œâ”€â”€ step3_mock_agent.py      # Step 3: Mock Agentæ‰§è¡Œï¼ˆæ”¯æŒmonitorï¼‰
â”‚   â”œâ”€â”€ step4_monitor_actions.py # Step 4: å®æ—¶ç›‘æ§ï¼ˆç®€åŒ–Scope Guardï¼‰
â”‚   â””â”€â”€ step5_evaluate.py        # Step 5-6: äº‹åè¯„ä¼°
â”œâ”€â”€ utils/                    # âœ¨ UPDATED: å·¥å…·å’Œé…ç½®æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py                # âœ¨ NEW: é…ç½®ç®¡ç†ï¼ˆæƒé‡/é˜ˆå€¼/limitsï¼‰
â”‚   â”œâ”€â”€ logging_utils.py         # âœ¨ NEW: å¯å¤ç°æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ evaluator_bridge.py      # âœ¨ NEW: SWE-bench evaluatoræ¥å£
â”‚   â””â”€â”€ simple_agent.py          # âœ¨ NEW: çœŸå®Agentï¼ˆBedrock APIï¼‰
â”œâ”€â”€ docs/                     # âœ¨ NEW: æ–‡æ¡£ç›®å½•
â”‚   â””â”€â”€ 2025-10-28-2-README.md   # æœ¬æ–‡ä»¶
â”œâ”€â”€ logs/                     # å®éªŒæ—¥å¿—è¾“å‡ºç›®å½•
â”œâ”€â”€ run_full_demo.py         # âœ¨ UPDATED: å®Œæ•´æµç¨‹ï¼ˆé›†æˆloggingï¼‰
â”œâ”€â”€ run_with_real_agent.py   # DEPRECATED: è¿é€šæ€§è‡ªæ£€è„šæœ¬ï¼ˆå»ºè®®ç”¨ generate_predictions.py / batch_generate_predictions.pyï¼‰
â”œâ”€â”€ generate_predictions.py  # ç”Ÿæˆå•ä»»åŠ¡ predictions.jsonlï¼ˆæ”¯æŒ --full_file_mode / --unifiedï¼‰
â”œâ”€â”€ batch_generate_predictions.py  # âœ¨ NEW: æ‰¹é‡ç”Ÿæˆ predictions.jsonlï¼ˆæ”¯æŒ --full_file_mode / --unifiedï¼ŒæŒ‰æ—¶é—´æˆ³ç›®å½•è¾“å‡ºï¼‰
â””â”€â”€ quick_test.py            # å¿«é€Ÿæµ‹è¯•ï¼ˆæ— äº¤äº’ï¼‰
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### âœ… "1è¡Œèµ°é€š" - å·²å®Œæˆï¼

```bash
cd /Users/jeremy/Dropbox/cs224v-project/cs224v-research/agent-memory-lab-v3/demo

# Option 1: å¿«é€Ÿæµ‹è¯•ï¼ˆMock Agentï¼‰
python quick_test.py

# Option 2: å®Œæ•´Demoï¼ˆé›†æˆloggingï¼‰
python run_full_demo.py

# Option 3: çœŸå®Agentè¿é€šæ€§è‡ªæ£€ï¼ˆDEPRECATEDï¼‰
python run_with_real_agent.py

# Option 4: ç”Ÿæˆå•ä»»åŠ¡ predictions.jsonlï¼ˆæ›´ç¨³å¥ï¼Œå»ºè®®å¼€å¯æ›´å¤§ä¸Šä¸‹æ–‡ï¼‰
python generate_predictions.py --full_file_mode true --unified 10
# è¾“å‡ºæ–‡ä»¶ï¼šdemo/logs/predictions.jsonlï¼ˆå•ä¸ªæ–‡ä»¶ã€å•è¡Œï¼‰

# Option 5: æ‰¹é‡ç”Ÿæˆ predictions.jsonlï¼ˆLLMï¼Œæœ€å¤§æˆåŠŸç‡ï¼‰
python batch_generate_predictions.py --start 0 --end 500 --full_file_mode true --unified 10
# è¾“å‡ºåˆ°ï¼šlogs/<timestamp>/predictions/input_data_{i}/{instance_id}/predictions.jsonl
# éœ€è¦ï¼šAWS_BEARER_TOKEN_BEDROCKï¼Œå¹¶ä¼šæ‰“å°è¿è¡Œå¥åº·æ±‡æ€»ï¼›å¤±è´¥ä»»åŠ¡å†™å…¥ bad_patch.diff

# åˆå¹¶ä¸º evaluator å¯ç”¨çš„å¤šè¡Œ JSONLï¼š
find logs/<timestamp>/predictions -name predictions.jsonl -print0 \
  | xargs -0 cat > logs/<timestamp>/predictions_merged.jsonl
```

### ğŸ¯ éªŒæ”¶æ ‡å‡† - å…¨éƒ¨è¾¾æˆï¼

âœ… æ–‡ä»¶ç»“æ„é‡ç»„å®Œæˆï¼ˆsteps/ utils/ï¼‰
âœ… SimpleBedrockAgentèƒ½ç”Ÿæˆpatch
âœ… 1ä¸ªä»»åŠ¡çš„patchç”ŸæˆæˆåŠŸ
âœ… predictions.jsonlæ ¼å¼æ­£ç¡®
âœ… å®Œæ•´çš„1è¡Œç«¯åˆ°ç«¯æµç¨‹èµ°é€šï¼

### ä¸‹ä¸€æ­¥ï¼šè¿è¡Œå®˜æ–¹evaluator

```bash
# è®¾ç½®AWS tokenä»¥ä½¿ç”¨çœŸå®APIï¼ˆå¯é€‰ï¼‰
export AWS_BEARER_TOKEN_BEDROCK=...

# å•ä»»åŠ¡ï¼šç”Ÿæˆ predictions.jsonlï¼ˆå»ºè®®å…¨æ–‡ä»¶æ¨¡å¼ + æ›´å¤§ä¸Šä¸‹æ–‡ï¼‰
python generate_predictions.py --full_file_mode true --unified 10

# æ‰¹é‡ï¼šä¸ºå‰500ä¸ªä»»åŠ¡ç”Ÿæˆ predictions.jsonlï¼ˆéœ€ AWS_BEARER_TOKEN_BEDROCKï¼‰
python batch_generate_predictions.py --start 0 --end 500 --full_file_mode true --unified 10
echo "æ‰¹é‡è¾“å‡ºä½äº logs/<timestamp>/predictions/input_data_{i}/{instance_id}/predictions.jsonl"

# TODO: è¿è¡Œå®˜æ–¹SWE-bench evaluatorï¼ˆéœ€è¦Dockerï¼‰
# å‚è€ƒ utils/evaluator_bridge.py ä¸­çš„è¯´æ˜
```

### å•ç‹¬è¿è¡Œå„æ­¥éª¤

```bash
# Step 1: æ•°æ®åŠ è½½
python -m steps.step1_load_data

# Step 2: Four-Guardåˆå§‹åŒ–
python -m steps.step2_init_guards

# Step 3: Mock Agentæ‰§è¡Œ
python -m steps.step3_mock_agent

# Step 4: å®æ—¶ç›‘æ§
python -m steps.step4_monitor_actions

# Step 5-6: äº‹åè¯„ä¼°
python -m steps.step5_evaluate

# æµ‹è¯•çœŸå®Agent
python -m utils.simple_agent
```

---

## ğŸ“‹ æµç¨‹è¯´æ˜

### Step 1: æ•°æ®åŠ è½½ä¸è§£æ (`step1_load_data.py`)

**åŠŸèƒ½**: ä»`verified.jsonl`åŠ è½½ä»»åŠ¡ï¼Œå¹¶æŒ‰ç…§Part A/B/Cåˆ†ç±»

**è¾“å‡º**:
- Part A (ç»™Agent): `problem_statement`, `repo`, `base_commit`
- Part B (ç»™Q1ç›‘æ§): `difficulty`, `FAIL_TO_PASS`, `PASS_TO_PASS`
- Part C (è¯„ä¼°ç”¨): `ground_truth_patch`, æµ‹è¯•åˆ—è¡¨

**ç¤ºä¾‹**:
```python
from step1_load_data import load_task
from pathlib import Path

DATA_FILE = Path("../data/swebench/verified.jsonl")
task = load_task(DATA_FILE, task_index=0)

# è·å–ä¸‰éƒ¨åˆ†æ•°æ®
part_a = task.get_part_a()  # ç»™Agent
part_b = task.get_part_b()  # ç»™Q1ç›‘æ§
part_c = task.get_part_c()  # è¯„ä¼°ç”¨
```

---

### Step 2: Four-Guardåˆå§‹åŒ– (`step2_init_guards.py`)

**åŠŸèƒ½**: åˆå§‹åŒ–Four-Guardç›‘æ§å™¨ï¼ŒåŒ…å«2ä¸ªLLMè°ƒç”¨

**LLMè°ƒç”¨ç‚¹**:
1. **Parse Scope**: ä»`problem_statement`è§£æé¢„æœŸä¿®æ”¹èŒƒå›´
2. **Parse Plan**: ä»`problem_statement`è§£æé¢„æœŸæ‰§è¡Œæ­¥éª¤

**é…ç½®** (æ¥è‡ªproposal v2):
- å®ˆå«æƒé‡: `Scope=0.4, Plan=0.3, Test=0.2, Evidence=0.1`
- é˜ˆå€¼: `WARN=0.5, ROLLBACK=0.8`
- Scopeæ–‡ä»¶é™åˆ¶: æ ¹æ®`difficulty`åŠ¨æ€è®¾ç½®

**ç¤ºä¾‹**:
```python
from step2_init_guards import FourGuardMonitor

monitor = FourGuardMonitor(task)

# æŸ¥çœ‹é…ç½®
summary = monitor.get_summary()
print(summary['weights'])        # {'scope': 0.4, ...}
print(summary['scope_file_limit'])  # 2 (for <15min task)
```

---

### Step 3: Mock Agentæ‰§è¡Œ (`step3_mock_agent.py`)

**åŠŸèƒ½**: æ¨¡æ‹Ÿä¸€ä¸ªagentæ‰§è¡Œè¿‡ç¨‹ï¼Œç”Ÿæˆä¸€ç³»åˆ—actions

**æ³¨æ„**: è¿™æ˜¯demoç”¨çš„mock agentï¼Œå®é™…Q1ä¼šé›†æˆçœŸå®agentï¼ˆå¦‚SWE-agentï¼‰

**Actionsç”Ÿæˆ**:
1. Phase 1 (Understand): `read_file(...)`
2. Phase 2 (Reproduce): `run_test(...)`
3. Phase 3 (Implement): `edit_file(...)`
4. Phase 4 (Verify): `run_test(...)`
5. Submit: `submit()`

**è¾“å‡º**:
- `patch`: agentç”Ÿæˆçš„git diff
- `actions`: æ‰€æœ‰actionçš„åˆ—è¡¨

**ç¤ºä¾‹**:
```python
from step3_mock_agent import MockAgent

agent = MockAgent(task.problem_statement, task.repo)
result = agent.execute()

print(result['patch'])          # git diffæ ¼å¼
print(len(result['actions']))   # ä¾‹å¦‚: 7ä¸ªactions
```

---

### Step 4: å®æ—¶ç›‘æ§ (`step4_monitor_actions.py`)

**åŠŸèƒ½**: Four-Guardç›‘æ§æ¯ä¸ªactionï¼Œè®¡ç®—drift score

**ç›‘æ§æµç¨‹** (æ¯ä¸ªaction):
1. **Scope Guard**: æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ˜¯å¦è¶…å‡ºèŒƒå›´
2. **Plan Guard**: æ£€æŸ¥actionæ˜¯å¦ç¬¦åˆå½“å‰phase
3. **Test Guard**: æ£€æŸ¥æ˜¯å¦è¿è¡Œå¿…éœ€çš„æµ‹è¯•
4. **Evidence Guard**: æ£€æŸ¥actionæ˜¯å¦æœ‰å……åˆ†ä¾æ®ï¼ˆLLMè°ƒç”¨ï¼‰

**Drift Scoreè®¡ç®—**:
```
drift_score = 0.4 Ã— scope_violation
            + 0.3 Ã— plan_violation
            + 0.2 Ã— test_violation
            + 0.1 Ã— evidence_violation
```

**å†³ç­–**:
- `drift < 0.5`: âœ… ALLOW (ç»§ç»­)
- `0.5 â‰¤ drift < 0.8`: âš ï¸ WARN (è­¦å‘Šä½†å…è®¸)
- `drift â‰¥ 0.8`: ğŸš« ROLLBACK (å»ºè®®å›æ»š)

**ç¤ºä¾‹**:
```python
from step4_monitor_actions import ActionMonitor

monitor = ActionMonitor(guard)

for action in agent_actions:
    result = monitor.monitor_action(action, idx)
    print(result['drift_score'])  # ä¾‹å¦‚: 0.15
    print(result['decision'])      # {'action': 'ALLOW', 'emoji': 'âœ…'}
```

---

### Step 5-6: äº‹åè¯„ä¼° (`step5_evaluate.py`)

**åŠŸèƒ½**: å¯¹æ¯”agentç»“æœä¸ground truthï¼Œè®¡ç®—metrics

**è¯„ä¼°1: åŠŸèƒ½æ­£ç¡®æ€§ (Resolved)**
- **å®é™…**: åº”ä½¿ç”¨SWE-benchå®˜æ–¹Docker evaluator
- **Demo**: ä½¿ç”¨mockç‰ˆæœ¬ï¼ˆç®€åŒ–åˆ¤æ–­ï¼‰
- **æ ‡å‡†**: `FAIL_TO_PASSå…¨é€šè¿‡ AND PASS_TO_PASSå…¨é€šè¿‡`

**è¯„ä¼°2: Scopeå¯¹é½åˆ†æ**
- **Precision**: `|gold âˆ© agent| / |agent|` (agentæ”¹å¯¹çš„æ¯”ä¾‹)
- **Recall**: `|gold âˆ© agent| / |gold|` (ground truthè¢«è¦†ç›–çš„æ¯”ä¾‹)

**è¾“å‡ºæŒ‡æ ‡**:
- `resolved`: åŠŸèƒ½æ˜¯å¦æ­£ç¡® (True/False)
- `scope_precision`: Scopeç²¾ç¡®åº¦ (0.0-1.0)
- `scope_recall`: Scopeå¬å›ç‡ (0.0-1.0)
- `drift_rate`: Driftæ¯”ä¾‹ (0.0-1.0)

**ç¤ºä¾‹**:
```python
from step5_evaluate import evaluate_scope, evaluate_resolved_mock

# Scopeåˆ†æ
scope_result = evaluate_scope(agent_patch, ground_truth_patch)
print(scope_result['scope_precision'])  # 1.0 = å®Œç¾
print(scope_result['extra_files'])      # [] = æ²¡æœ‰å¤šæ”¹

# Resolvedè¯„ä¼°ï¼ˆmockï¼‰
resolved_result = evaluate_resolved_mock(agent_patch, fail_to_pass, pass_to_pass)
print(resolved_result['resolved'])      # True/False
```

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: æ•°æ®åŠ è½½ä¸è§£æ                                     â”‚
â”‚  Input: verified.jsonl (line 0)                            â”‚
â”‚  Output: Part A (Agent), Part B (Q1), Part C (è¯„ä¼°)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Four-Guardåˆå§‹åŒ–                                  â”‚
â”‚  ğŸ¤– LLMè°ƒç”¨1: Parse Scope                                  â”‚
â”‚  ğŸ¤– LLMè°ƒç”¨2: Parse Plan                                   â”‚
â”‚  Output: FourGuardMonitoré…ç½®å¥½                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Agentæ‰§è¡Œä»»åŠ¡                                      â”‚
â”‚  Mock Agentç”Ÿæˆ7ä¸ªactions                                  â”‚
â”‚  Output: patch + actionåˆ—è¡¨                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: å®æ—¶ç›‘æ§æ¯ä¸ªAction                                â”‚
â”‚  For each action:                                          â”‚
â”‚    - å››ä¸ªå®ˆå«æ£€æŸ¥ â†’ drift_score                            â”‚
â”‚    - å†³ç­–: ALLOW/WARN/ROLLBACK                             â”‚
â”‚  Output: monitoring_results + drift_rate                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5-6: äº‹åè¯„ä¼°                                        â”‚
â”‚  1. Resolvedè¯„ä¼°ï¼ˆæµ‹è¯•é€šè¿‡ç‡ï¼‰                             â”‚
â”‚  2. Scopeåˆ†æï¼ˆPrecision/Recallï¼‰                          â”‚
â”‚  Output: resolved + scope_metrics                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ€ç»ˆç»“æœ                                                   â”‚
â”‚  - Resolved: True/False                                    â”‚
â”‚  - Drift Rate: X%                                          â”‚
â”‚  - Scope Precision/Recall: X.XX                            â”‚
â”‚  â†’ åˆ†ç±»: å®Œç¾/æˆåŠŸä½†æ›²æŠ˜/å¤±è´¥                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‰ P0å®ŒæˆçŠ¶æ€ï¼ˆ2024-10-28ï¼‰

### âœ… å·²å®Œæˆçš„P0ä»»åŠ¡ (100%)

| P0ä»»åŠ¡ | è¯´æ˜ | çŠ¶æ€ | æ–‡ä»¶ |
|--------|------|------|------|
| **1. ç§»é™¤LLM Parse Scope/Plan** | Q1ä¸éœ€è¦"é¢„æµ‹"ï¼ | âœ… å®Œæˆ | steps/step2_init_guards.py |
| **2. ç®€åŒ–Scope Guard** | åªæ£€æŸ¥æ–‡ä»¶æ•°ï¼Œä¸é¢„æµ‹expected_scope | âœ… å®Œæˆ | steps/step4_monitor_actions.py |
| **3. é…ç½®ç®¡ç†** | ç»Ÿä¸€ç®¡ç†æƒé‡/é˜ˆå€¼/flags | âœ… å®Œæˆ | utils/config.py |
| **4. Evaluatoræ¥å£** | ç”Ÿæˆpredictions.jsonl + ä½¿ç”¨è¯´æ˜ | âœ… å®Œæˆ | utils/evaluator_bridge.py |
| **5. å¯å¤ç°æ—¥å¿—** | events/guards/results/meta logs | âœ… å®Œæˆ | utils/logging_utils.py |
| **6. Monitoré›†æˆ** | MockAgentæ”¯æŒQ1ç›‘æ§ | âœ… å®Œæˆ | steps/step3_mock_agent.py |
| **7. æ–‡ä»¶ç»“æ„é‡ç»„** | steps/ å’Œ utils/ åˆ†ç¦» | âœ… å®Œæˆ | å…¨éƒ¨æ–‡ä»¶ |
| **8. çœŸå®Agenté›†æˆ** | SimpleBedrockAgent (Bedrock API) | âœ… å®Œæˆ | utils/simple_agent.py |
| **9. "1è¡Œèµ°é€š"** | å®Œæ•´ç«¯åˆ°ç«¯æµç¨‹ | âœ… å®Œæˆï¼ˆå·²å¼ƒç”¨å…¥å£ï¼‰ | run_with_real_agent.py |
| **10. Predictionsç”Ÿæˆ** | å•ä»»åŠ¡ predictions.jsonl | âœ… å®Œæˆ | generate_predictions.py |
| **11. æ‰¹é‡ç”Ÿæˆ** | æ‰¹é‡ predictions.jsonlï¼ˆå…¨æ–‡ä»¶æ¨¡å¼/ç»Ÿä¸€ä¸Šä¸‹æ–‡ï¼‰ | âœ… å®Œæˆ | batch_generate_predictions.py |

### æ ¸å¿ƒæ”¹è¿›ï¼šQ1ä¸éœ€è¦LLMï¼

**ä¹‹å‰çš„è¯¯è§£**ï¼š
```
Parse Scope (LLM) â†’ é¢„æµ‹expected_files â†’ æ£€æŸ¥agentæ”¹å¯¹äº†å—
æˆæœ¬: ~$15/500ä»»åŠ¡
```

**ç°åœ¨çš„æ­£ç¡®ç†è§£**ï¼š
```
Scope Guard: æ–‡ä»¶æ•° > difficulty_limit? (è§„åˆ™æ£€æŸ¥)
Plan Guard:  editå‰run test? (è§„åˆ™æ£€æŸ¥)
Test Guard:  è¿è¡ŒFAIL_TO_PASS? (è§„åˆ™æ£€æŸ¥)
Evidence:    read before edit? (ç®€å•å†å²)
æˆæœ¬: $0 âœ…
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ›´å¯é ï¼ˆè§„åˆ™æ˜ç¡®ï¼Œä¸ä¼šè¯¯æŠ¥ï¼‰
- âœ… æ›´ä¾¿å®œï¼ˆ$0æˆæœ¬ï¼‰
- âœ… æ›´å¿«é€Ÿï¼ˆæ— APIå»¶è¿Ÿï¼‰
- âœ… æ›´å¯å¤ç°ï¼ˆç¡®å®šæ€§è§„åˆ™ï¼‰

## âš ï¸ Demoé™åˆ¶è¯´æ˜

Q&Aï¼ˆæ›´ç›´æ¥çš„ç­”æ¡ˆï¼‰
- ä¸ºä»€ä¹ˆä¸ç”¨LLMå»parseåŸå§‹æ•°æ®ï¼Ÿæ•°æ®æœ¬èº«æ˜¯ç»“æ„åŒ–JSONï¼›è§„åˆ™è§£ææ›´ç¨³ã€å¯å¤ç°ã€æˆæœ¬ä½ï¼Œä¸”é¿å…è¯¯æŠ¥ä¸ä¿¡æ¯æ³„æ¼ã€‚Q1éœ€è¦çš„æ˜¯"å¯è§‚æµ‹è¿‡ç¨‹ä¿¡å·"ï¼Œä¸æ˜¯è¯­ä¹‰çŒœæµ‹ã€‚
- æœ€ç»ˆæä¾›è§£å†³æ–¹æ¡ˆéœ€è¦LLMå—ï¼Ÿé€šå¸¸éœ€è¦ã€‚å†™/æ”¹ä»£ç çš„æ˜¯Agentï¼ˆå¤šä¸ºLLMï¼‰ã€‚Q1ä¸å†™ä»£ç ã€‚
- æˆ‘ä»¬çš„è´¡çŒ®æ˜¯ä¸æ˜¯ï¼šåˆ¤å®šdriftâ†’ç»™å»ºè®®â†’å¦åˆ™æ”¾è¡Œï¼Ÿæ˜¯ã€‚ä¸‰æ­¥éƒ½å¯ç”¨è§„åˆ™å®Œæˆï¼š
  - Scopeï¼šæ§åˆ¶å·²æ”¹æ–‡ä»¶æ•°é‡
  - Planï¼šå…ˆæµ‹åæ”¹ã€æŒ‰ç›¸ä½é¡ºåº
  - Testï¼šè¦†ç›–FAIL_TO_PASSï¼›Evidenceï¼šæ˜¯å¦è¯»è¿‡è¢«æ”¹æ–‡ä»¶
  å»ºè®®å¯æ¨¡æ¿åŒ–ï¼ˆå¦‚"å…ˆè¿è¡Œå¿…æµ‹ï¼Œå†è¿›å…¥å®ç°""å‡å°‘æ”¹åŠ¨é¢/å›é€€æœ€è¿‘æ”¹åŠ¨"ï¼‰ï¼Œä¸å¿…ç”¨LLMã€‚
- è¿™äº›è¿‡ç¨‹éœ€è¦LLMå¸®å†™ä»£ç å—ï¼Ÿä¸éœ€è¦ã€‚å†™ä»£ç ç”±Agentè´Ÿè´£ã€‚
- Resolve Rate éš¾é“ä¸éœ€è¦LLMï¼Ÿéœ€è¦ä¸€ä¸ªä¼šè§£é¢˜çš„Agentæ¥äº§ç”Ÿè¡¥ä¸ï¼›Q1é€šè¿‡é™driftè®©åŒä¸€ä¸ªAgentæ›´ç¨³å®šï¼Œé—´æ¥æé«˜Resolveã€‚
- æ˜¯å¦è¦è·‘ä¸¤æ¬¡ï¼šä¸€æ¬¡æœ‰LLMï¼Œä¸€æ¬¡æ²¡æœ‰LLMï¼Ÿä¸æ˜¯ã€‚å›ºå®šåŒä¸€ä¸ªï¼ˆé€šå¸¸æ˜¯LLMï¼‰Agentï¼Œå¯¹æ¯”"æ— Q1/æœ‰Q1ï¼ˆshadow/advisory/enforceï¼‰"ã€‚
- æŒ‡æ ‡å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ
  - Primaryï¼šResolve Rateï¼ˆå®˜æ–¹evaluatorè·‘FAIL_TO_PASS+PASS_TO_PASSï¼‰ã€‚
  - Q1æŒ‡æ ‡ï¼šDrift Rateã€Scope Precision/Recallï¼ˆè¿‡ç¨‹æŒ‡æ ‡ï¼Œç”¨æ¥è§£é‡Š/å½’å› Q1å¦‚ä½•å½±å“ç»“æœï¼Œå¹¶æŒ‡å¯¼è°ƒå‚ï¼‰ã€‚
- ç°åœ¨demoç¼ºä»€ä¹ˆï¼Ÿä¸¤ç‚¹ï¼š
  1) æ¥å®˜æ–¹evaluatorï¼ˆâœ… evaluator_bridge.pyå·²å‡†å¤‡å¥½æ¥å£ï¼‰ã€‚
  2) æ¥èƒ½äº§å‡ºpatchçš„çœŸå®Agentï¼ˆé€šå¸¸æ˜¯LLMï¼‰ã€‚

æœ€å°è½åœ°åŠ¨ä½œï¼ˆä¸æ”¹ç»“æ„ï¼‰
- âœ… ç”Ÿæˆpredictions.jsonlå¹¶ç»™å‡ºå®˜æ–¹è¯„æµ‹å‘½ä»¤ï¼ˆevaluator_bridge.pyå®Œæˆï¼‰ã€‚
- âœ… å›ºå®šåŒä¸€AgentåšA/Bï¼šBaseline(æ— Q1)â†’Shadowâ†’Advisoryï¼ˆconfig.pyæ”¯æŒï¼‰ã€‚
- âœ… è¾“å‡ºevents.jsonlã€guards.jsonlã€run_meta.jsonï¼ˆlogging_utils.pyå®Œæˆï¼‰ã€‚


### 1. Mock Agent
- **Demo**: ä½¿ç”¨ç®€åŒ–çš„mock agentï¼Œç”Ÿæˆé¢„å®šä¹‰çš„actionåºåˆ—
- **å®é™…**: éœ€è¦é›†æˆçœŸå®agentï¼ˆSWE-agentæˆ–è‡ªå®šä¹‰GPT-4 agentï¼‰

### 2. Mock LLMè°ƒç”¨
- **Demo**: Parse Scope/Planä½¿ç”¨å¯å‘å¼è§„åˆ™ï¼ŒEvidence Guardç®€åŒ–åˆ¤æ–­
- **å®é™…**: éœ€è¦è°ƒç”¨OpenAI API (GPT-4o) æˆ–æœ¬åœ°LLM (Qwen-32B)

### 3. Mock Resolvedè¯„ä¼°
- **Demo**: ç®€å•åˆ¤æ–­patchæ˜¯å¦æœ‰æ”¹åŠ¨
- **å®é™…**: éœ€è¦ä½¿ç”¨SWE-benchå®˜æ–¹Docker evaluatorè¿è¡Œæµ‹è¯•

---

## ğŸ”§ å®é™…å®ç°è¦ç‚¹

### 1. LLMé›†æˆ

```python
import openai

def parse_scope_with_real_llm(problem_statement):
    """å®é™…LLMè°ƒç”¨å®ç°"""
    response = openai.ChatCompletion.create(
        model="gpt-4o",
        messages=[{
            "role": "user",
            "content": f"""Task: {problem_statement}

Question: Which files need modification?
Return JSON: {{"files": ["path1.py", "path2.py"]}}"""
        }]
    )
    return json.loads(response.choices[0].message.content)['files']
```

### 2. Agenté›†æˆ

```python
# Option 1: ä½¿ç”¨SWE-agent
from sweagent import SWEAgent

agent = SWEAgent()
monitor = FourGuardMonitor(task)

# æ³¨å…¥ç›‘æ§å™¨
agent.add_monitor(monitor)
result = agent.solve(task)

# Option 2: è‡ªå®šä¹‰ç®€åŒ–agent
class SimpleGPT4Agent:
    def execute(self, task):
        # GPT-4è°ƒç”¨ + å·¥å…·æ‰§è¡Œ + ç›‘æ§é›†æˆ
        ...
```

### 3. SWE-benchè¯„ä¼°å™¨é›†æˆ

```bash
# æ–¹å¼ Aï¼šå•ä»»åŠ¡ï¼ˆä¸Šä¸€èŠ‚ Option 4 ç”Ÿæˆçš„ï¼‰
python -m swebench.harness.run_evaluation \
  --predictions_path agent-memory-lab-v3/demo/logs/predictions.jsonl \
  --swe_bench_tasks agent-memory-lab-v3/demo/data/swebench/verified.jsonl \
  --log_dir logs/eval-single

# æ–¹å¼ Bï¼šæ‰¹é‡ï¼ˆåˆå¹¶åçš„ predictions_merged.jsonlï¼‰
python -m swebench.harness.run_evaluation \
  --predictions_path logs/<timestamp>/predictions_merged.jsonl \
  --swe_bench_tasks agent-memory-lab-v3/demo/data/swebench/verified.jsonl \
  --log_dir logs/eval-batch

# æŸ¥çœ‹ç»“æœ
cat logs/eval-single/results.json  # æˆ– logs/eval-batch/results.json
```

---

## ğŸ“ˆ é¢„æœŸWeek 1å®éªŒç»“æœ

### Baseline (Unmonitored, Q1å…³é—­)
- Resolve Rate: ~25%
- Drift Rate: ~35%
- Scope Precision: ~0.60

### With Q1 (Advisory Mode, Q1å¼€å¯)
- Resolve Rate: â‰¥30% âœ… (+5%)
- Drift Rate: <15% âœ… (-20%)
- Scope Precision: â‰¥0.85 âœ… (+0.25)

---

## ğŸ’¡ Next Steps

### âœ… å·²å®Œæˆ (Day 1-3)
- [x] å®ç°çœŸå®çš„LLMè°ƒç”¨ â†’ **ä¸éœ€è¦ï¼Q1ä½¿ç”¨è§„åˆ™å³å¯**
- [x] é›†æˆçœŸå®agent â†’ **SimpleBedrockAgentå®Œæˆ**
- [x] å®Œå–„Four-Guardé€»è¾‘ â†’ **è§„åˆ™ç‰ˆæœ¬å®Œæˆ**
- [x] æ–‡ä»¶ç»“æ„é‡ç»„ â†’ **steps/ å’Œ utils/ åˆ†ç¦»**
- [x] "1è¡Œèµ°é€š" â†’ **run_with_real_agent.py å®Œæˆï¼ˆå…¥å£å·²å¼ƒç”¨ï¼Œç”¨äºè¿é€šæ€§è‡ªæ£€ï¼‰**
- [x] predictions.jsonlç”Ÿæˆ â†’ **generate_predictions.py / batch_generate_predictions.py å®Œæˆ**

### ğŸš§ å¾…å®Œæˆ (Day 4-7)

#### Day 4: å®˜æ–¹Evaluatoræµ‹è¯•
- [ ] é…ç½®SWE-bench Dockerç¯å¢ƒ
- [ ] è¿è¡Œå®˜æ–¹evaluator on 1 task
- [ ] è·å¾—çœŸå®resolvedç»“æœ

#### Day 5: Baselineå»ºç«‹
- [ ] åœ¨5ä¸ªç®€å•ä»»åŠ¡(<15min)ä¸Šè¿è¡ŒSimpleBedrockAgent
- [ ] è®°å½•baseline drift_rateå’Œresolve_rate
- [ ] åˆ†æç»“æœï¼Œè¯†åˆ«é—®é¢˜

#### Day 6-7: Advisory Modeæµ‹è¯•
- [ ] å¼€å¯Advisory Modeï¼ˆWARN/ROLLBACKï¼‰
- [ ] å¯¹æ¯”Baseline vs Advisoryæ•ˆæœ
- [ ] è°ƒæ•´weightså’Œthresholds
- [ ] å‡†å¤‡å¯¼å¸ˆæ±‡æŠ¥ææ–™

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Q1_END_TO_END_WORKFLOW.md**: å®Œæ•´æŠ€æœ¯æ–‡æ¡£ï¼ˆ80é¡µè¯¦ç»†è¯´æ˜ï¼‰
- **000-original plan-v2.md**: Proposalæœ€ç»ˆç‰ˆæœ¬
- **scripts/swe-bench-data/**: æ•°æ®ä¸‹è½½å’Œåˆ†æå·¥å…·

---

## ğŸ› è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹å•ä¸ªä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯
```python
from step1_load_data import load_task
from pathlib import Path

task = load_task(Path("../data/swebench/verified.jsonl"), task_index=0)
print(task.instance_id)
print(task.difficulty)
print(task.problem_statement)
```

### æ‰‹åŠ¨æµ‹è¯•Four-Guard
```python
from step2_init_guards import FourGuardMonitor

monitor = FourGuardMonitor(task)
print(monitor.get_summary())
```

### æ£€æŸ¥monitoringç»“æœ
```python
from step4_monitor_actions import ActionMonitor

for result in monitoring_results:
    if result['drift_score'] >= 0.5:
        print(f"Drift detected at action {result['action_index']}")
        print(f"  Drift score: {result['drift_score']}")
        print(f"  Decision: {result['decision']}")
```

---

## âœ… DemoéªŒè¯æ¸…å•

è¿è¡Œ`run_full_demo.py`åï¼Œç¡®è®¤ä»¥ä¸‹è¾“å‡ºï¼š

- [x] Step 1: TaskåŠ è½½æˆåŠŸï¼Œæ˜¾ç¤ºPart A/B/C
- [x] Step 2: Four-Guardåˆå§‹åŒ–ï¼Œæ˜¾ç¤ºweightså’Œthresholds
- [x] Step 3: Mock Agentæ‰§è¡Œï¼Œç”Ÿæˆpatchå’Œactions
- [x] Step 4: æ¯ä¸ªactionçš„drift scoreè®¡ç®—æ­£ç¡®
- [x] Step 5-6: Resolvedå’ŒScope metricsè¾“å‡º
- [x] æœ€ç»ˆç»“æœ: æ­£ç¡®åˆ†ç±»ï¼ˆå®Œç¾/æˆåŠŸä½†æ›²æŠ˜/å¤±è´¥ï¼‰

---

**Ready to implement real Q1!** ğŸš€
