  âœ… ç°åœ¨çš„ç»“æ„ï¼ˆæ¸…æ™°ï¼‰

  data/2_runs/
  â””â”€â”€ s_2025-10-26-10-20-36_cursor/  â† sessionæ–‡ä»¶å¤¹
      â”œâ”€â”€ q01/
      â”œâ”€â”€ q02/
      â”œâ”€â”€ q03/
      â”œâ”€â”€ q04/
      â””â”€â”€ summary.json  â† åœ¨sessionå†…

  å®Œæ•´çš„æ•°æ®æµç»“æ„

  ç°åœ¨æ•´ä¸ªpipelineçš„ç»“æ„å®Œå…¨ä¸€è‡´ï¼š

  data/
  â”œâ”€â”€ 1_sessions/                         # Step 1è¾“å‡º (LLM âœ…)
  â”‚   â””â”€â”€ s_2025-10-26-10-20-36_cursor/
  â”‚       â”œâ”€â”€ session.json
  â”‚       â”œâ”€â”€ pairs.json
  â”‚       â”œâ”€â”€ raw/full_conversation.md
  â”‚       â””â”€â”€ pairs/
  â”‚           â”œâ”€â”€ q01/
  â”‚           â”‚   â”œâ”€â”€ chat.md
  â”‚           â”‚   â””â”€â”€ goal.json
  â”‚           â”œâ”€â”€ q02/
  â”‚           â”œâ”€â”€ q03/
  â”‚           â””â”€â”€ q04/
  â”‚
  â””â”€â”€ 2_runs/                             # Step 2è¾“å‡º (NO LLM âŒ)
      â””â”€â”€ s_2025-10-26-10-20-36_cursor/   # â† ä¸1_sessionsç»“æ„ä¸€è‡´ï¼
          â”œâ”€â”€ q01/
          â”‚   â”œâ”€â”€ goal.json
          â”‚   â”œâ”€â”€ raw/cursor.md
          â”‚   â”œâ”€â”€ events.jsonl
          â”‚   â”œâ”€â”€ guards.jsonl
          â”‚   â””â”€â”€ artifacts/reflection.txt
          â”œâ”€â”€ q02/
          â”œâ”€â”€ q03/
          â”œâ”€â”€ q04/
          â””â”€â”€ summary.json                # â† sessionçº§åˆ«çš„æ±‡æ€»

  å¥½å¤„æ€»ç»“

  1. âœ… ç»“æ„ä¸€è‡´ï¼š1_sessionså’Œ2_runsç°åœ¨å®Œå…¨å¯¹åº”
  2. âœ… æ˜“äºç®¡ç†ï¼šåˆ é™¤sessionåªéœ€ä¸€ä¸ªå‘½ä»¤ï¼šrm -rf data/2_runs/s_xxx
  3. âœ… æ¸…æ™°æ˜äº†ï¼šsummary.jsonåœ¨sessionæ–‡ä»¶å¤¹å†…ï¼Œä¸æ•£è½åœ¨å¤–
  4. âœ… ç®€åŒ–è·¯å¾„ï¼šqueryç›®å½•ä½¿ç”¨ç®€æ´çš„q01, q02è€Œéé•¿é•¿çš„run_id

  Next Stepsæç¤ºä¹Ÿæ›´æ–°äº†

  ç°åœ¨è¿è¡Œå®Œä¼šæ˜¾ç¤ºï¼š
  1ï¸âƒ£  Review individual query results:
     cd data/2_runs/s_2025-10-26-10-20-36_cursor/q01
     cat guards.jsonl | head -5

  3ï¸âƒ£  Aggregate analysis across multiple sessions:
     cat data/2_runs/*/summary.json | python -c "..."

  æ‰€æœ‰æ”¹è¿›éƒ½å®Œæˆäº†ï¼ä½ è§‰å¾—è¿™ä¸ªæ–°ç»“æ„æ€ä¹ˆæ ·ï¼Ÿ ğŸ‰

> å¾ˆå¥½ï¼Œæˆ‘ä»¬çš„q1æ˜¯ä¸æ˜¯ç»“æŸäº†ï¼Ÿè¿˜æœ‰ä»€ä¹ˆè¦åšçš„å—ï¼Ÿæœ€åçš„è¾“å‡º'/Users/jeremy/Dropbox/cs224v-project/cs224v-rese
arch/agent-memory-lab-v3/data/2_runs/s_2025-10-26-10-20-36_cursor/q04/guards.jsonl'ï¼ˆQ1ï¼‰ æ˜¯è¿™ä¸ªå¯¹å—ï¼Ÿ 


âº âœ… Q1 æ ¸å¿ƒåŠŸèƒ½å·²ç»å®Œæˆï¼

  æ˜¯çš„ï¼Œguards.jsonl å°±æ˜¯ Q1 çš„æœ€ç»ˆè¾“å‡ºï¼

  Q1 çš„å®Œæ•´æ•°æ®æµ

  è¾“å…¥: cursor.md
    â†“
  Step 1: process_long_conversation.py (LLM âœ…)
    â†“
  è¾“å‡º: 1_sessions/s_xxx/pairs/q0x/
        â”œâ”€â”€ chat.md
        â””â”€â”€ goal.json
    â†“
  Step 2: run_q1_batch.py (NO LLM âŒ)
    â†“
    â”œâ”€â†’ chat2events.py â†’ events.jsonl
    â””â”€â†’ events2guards.py â†’ guards.jsonl â† Q1æœ€ç»ˆè¾“å‡ºï¼

  guards.jsonl å†…å®¹ç¤ºä¾‹

  {
    "id": "...",
    "run_id": "s_2025-10-26-10-20-36_cursor_q01",
    "step": 1,
    "scope_guard": 0.0,      // æ–‡ä»¶æ˜¯å¦åœ¨allowed_paths
    "plan_guard": 0.0,       // å·¥å…·æ˜¯å¦åœ¨å½“å‰phaseå…è®¸
    "test_guard": 0.0,       // æ˜¯å¦è¿è¡Œrequired_tests
    "evidence_guard": 0.0,   // æ˜¯å¦é™„å¸¦è¯æ®
    "drift_score": 0.0,      // åŠ æƒæ€»åˆ†
    "action": "ok",          // ok | warn | rollback
    "auto_fixable": false,
    "fix_cmd": null,
    "file": "src/main.py",
    "notes": null
  }

  ğŸ“Š Q1 å·²å®Œæˆçš„æ‰€æœ‰ç»„ä»¶

  âœ… æ ¸å¿ƒåŠŸèƒ½

  1. ç±»å‹å®šä¹‰ (types/)
    - GoalConfig, GuardScores
    - SessionMetadata, QueryAnswerPair
    - TaskTypeæšä¸¾ï¼ˆ8ä¸ªå€¼ï¼‰
  2. LLM Prompts (tools/prompts/)
    - extract_session_metadata.txt
    - extract_pair_metadata.txt
    - generate_goal_from_pair.txt
  3. Pipelineè„šæœ¬
    - process_long_conversation.py (Step 1, LLM)
    - chat2events.py (Step 2a, NO LLM)
    - events2guards.py (Step 2b, NO LLM)
    - run_q1_batch.py (ç¼–æ’)
  4. è¾…åŠ©å·¥å…·
    - runner.sh (è§£å†³PYTHONPATH)
    - utils.py (globåŒ¹é…ã€pytestè§£æ)
    - llm_client.py (LLM APIå°è£…)
  5. æµ‹è¯•
    - test_events2guards.py (34ä¸ªæµ‹è¯•ï¼Œå…¨éƒ¨é€šè¿‡ âœ…)
    - test_conversation_split.py
    - test_cursor_header.py
  6. æ–°å¢å­—æ®µ
    - operation, artifact_type, scope (ä»£ç æ¨æ–­ï¼Œä¸ç”¨LLM)

  âœ… å·²éªŒè¯

  - âœ… çœŸå®æ•°æ®æµ‹è¯•é€šè¿‡ï¼ˆsmall_chat.md, 4 queriesï¼‰
  - âœ… ç›®å½•ç»“æ„ä¼˜åŒ–ï¼ˆ2_runs/session/q0x/ï¼‰
  - âœ… LLMä½¿ç”¨æ ‡æ³¨æ¸…æ™°
  - âœ… Next stepsæŒ‡å¼•å®Œå–„

  âš ï¸ å¯é€‰çš„å¢å¼ºï¼ˆä¸ç´§æ€¥ï¼‰

  P1ä¼˜åŒ–ï¼ˆNice to haveï¼‰

  1. æ±‡æ€»åˆ†æè„šæœ¬
  # å½“å‰éœ€è¦æ‰‹åŠ¨åˆ†æ
  cat data/2_runs/*/summary.json

  # å¯ä»¥å†™ä¸ªè„šæœ¬
  ./runner.sh python tools/analyze_drift_summary.py data/2_runs/
  # è¾“å‡ºï¼š
  # - æ€»queriesæ•°
  # - Drift rate: X%
  # - æœ€å¸¸è§driftåŸå› 
  # - æŒ‰task_typeåˆ†ç»„çš„driftç»Ÿè®¡
  2. å¯è§†åŒ–æŠ¥å‘Š
  # ç”ŸæˆHTMLæŠ¥å‘Š
  ./runner.sh python tools/generate_q1_report.py data/2_runs/s_xxx/
  # è¾“å‡ºï¼šreport.htmlï¼ˆå›¾è¡¨ã€è¡¨æ ¼ã€å¯äº¤äº’ï¼‰
  3. --dry-runæ¨¡å¼
  # é¢„è§ˆLLMè°ƒç”¨æ¬¡æ•°å’Œæˆæœ¬
  ./runner.sh python tools/process_long_conversation.py cursor.md --dry-run
  # è¾“å‡ºï¼šå°†è°ƒç”¨LLM 21æ¬¡ï¼ˆçº¦$0.05ï¼‰
  4. README/æ–‡æ¡£
    - æ›´æ–°README.mdè¯´æ˜å¦‚ä½•ä½¿ç”¨Q1
    - æ·»åŠ examples/ç¤ºä¾‹
    - æ·»åŠ troubleshooting

  Q2è¡”æ¥ï¼ˆä¸‹ä¸€æ­¥ï¼‰

  Q1çš„è¾“å‡ºï¼ˆguards.jsonlï¼‰åº”è¯¥ä¼šç”¨äºQ2ï¼ˆpattern learningï¼‰ï¼Œå¯èƒ½éœ€è¦ï¼š
  - å¯¼å‡ºè„šæœ¬ï¼štools/export_for_q2.py
  - æ ‡è®°æˆåŠŸ/å¤±è´¥çš„session
  - æå–pattern features

  ğŸ¯ æˆ‘çš„å»ºè®®

  ç°åœ¨å¯ä»¥åšä¸¤ä»¶äº‹ä¹‹ä¸€ï¼š

  é€‰é¡¹Aï¼šQ1æ”¶å°¾å¹¶å¼€å§‹Q2

  # 1. å†™ä¸ªç®€å•çš„æ±‡æ€»è„šæœ¬ï¼ˆ10åˆ†é’Ÿï¼‰
  ./runner.sh python tools/analyze_drift_summary.py data/2_runs/

  # 2. æ›´æ–°READMEç®€è¦è¯´æ˜Q1ç”¨æ³•ï¼ˆ5åˆ†é’Ÿï¼‰

  # 3. å¼€å§‹Q2ï¼šPattern Learning

  é€‰é¡¹Bï¼šå…ˆå¤šè·‘æ•°æ®ï¼ŒéªŒè¯Q1

  # 1. æ”¶é›†10-20ä¸ªcursor chatæ–‡ä»¶

  # 2. æ‰¹é‡è¿è¡Œ
  for chat in cursor_chats/*.md; do
    ./runner.sh python tools/process_long_conversation.py "$chat"
  done

  for session in data/1_sessions/s_*; do
    ./runner.sh python tools/run_q1_batch.py "$session"
  done

  # 3. åˆ†æç»“æœï¼Œçœ‹drift detectionæ˜¯å¦åˆç†
  # 4. æ ¹æ®æ•°æ®è°ƒä¼˜weights/thresholdsï¼ˆå¦‚æœéœ€è¦ï¼‰

  æˆ‘æ¨èé€‰é¡¹Bï¼šå…ˆè·‘æ›´å¤šçœŸå®æ•°æ®ï¼ŒéªŒè¯Q1ç¡®å®æœ‰ä»·å€¼ï¼Œå†ä¼˜åŒ–/æ‰©å±•ã€‚

  ---
  Q1æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼ ä½ æƒ³ï¼š
  1. ç»§ç»­å®Œå–„Q1ï¼ˆæ±‡æ€»è„šæœ¬ã€æ–‡æ¡£ç­‰ï¼‰ï¼Ÿ
  2. å…ˆå¤šè·‘æ•°æ®éªŒè¯Q1ï¼Ÿ
  3. è¿˜æ˜¯ç›´æ¥å¼€å§‹Q2ï¼Ÿ

> å†ç¡®è®¤ä¸€ä¸‹ï¼šæˆ‘ä»¬context driftçš„å®šä¹‰æ˜¯ä¸€ä¸ªuser 
  prompt+answerçš„æ¥å›ï¼Œå¯¹å—ï¼Ÿé’ˆå¯¹æ•´ä¸ªchatï¼ˆå¾ˆé•¿ï¼Œå¤šä¸ªuser prompts+AI answers)ï¼Œæˆ‘ä»¬æ²¡æœ‰å®šä¹‰driftå¯¹å—ï¼Ÿ 

âº âœ… ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼

  å½“å‰Q1çš„Drift Detection Scope

  âœ… æ˜¯çš„ï¼Œdriftæ˜¯é’ˆå¯¹å•ä¸ªquery-answer pairå®šä¹‰çš„ï¼š
  - 1ä¸ªuser prompt + AIçš„å®Œæ•´response = 1ä¸ªpair
  - æ¯ä¸ªpairæœ‰è‡ªå·±çš„goal.jsonï¼ˆå®šä¹‰è¿™ä¸ªqueryçš„allowed_paths, required_testsç­‰ï¼‰
  - Drift detectionæ£€æŸ¥ï¼šè¿™ä¸ªpairå†…çš„AI actionsæ˜¯å¦åç¦»äº†è¿™ä¸ªpairçš„goal

  âœ… å¯¹çš„ï¼Œé’ˆå¯¹æ•´ä¸ªchatï¼ˆå¤šä¸ªpairsï¼‰ï¼Œæˆ‘ä»¬ç›®å‰æ²¡æœ‰å®šä¹‰driftï¼š
  - åªæœ‰ç®€å•çš„ç»Ÿè®¡ï¼ˆsummary.jsonï¼‰ï¼šæ¯ä¸ªpairæœ‰å¤šå°‘drift events
  - æ²¡æœ‰"session-level drift"çš„æ¦‚å¿µ

  å½“å‰å®ç°ç»†èŠ‚

  ç¤ºä¾‹ï¼šä¸€ä¸ª4-queryçš„chat

  æ•´ä¸ªchat (cursor.md):
  â”œâ”€ Q1: "Create a login function"
  â”‚   â””â”€ A1: [AI creates login.py]
  â”‚   â””â”€ goal.json: allowed_paths=["src/auth/login.py"]
  â”‚   â””â”€ drift detection: é’ˆå¯¹Q1+A1è¿™ä¸€å¯¹
  â”‚   â””â”€ guards.jsonl: Q1å†…çš„æ¯ä¸ªactionæ˜¯å¦drift
  â”‚
  â”œâ”€ Q2: "Add tests for login"
  â”‚   â””â”€ A2: [AI creates test_login.py]
  â”‚   â””â”€ goal.json: allowed_paths=["tests/test_login.py"]
  â”‚   â””â”€ drift detection: é’ˆå¯¹Q2+A2è¿™ä¸€å¯¹ï¼ˆç‹¬ç«‹äºQ1ï¼‰
  â”‚   â””â”€ guards.jsonl: Q2å†…çš„æ¯ä¸ªactionæ˜¯å¦drift
  â”‚
  â”œâ”€ Q3: "Fix the bug in login"
  â”‚   â””â”€ A3: [AI modifies login.py]
  â”‚   â””â”€ goal.json: allowed_paths=["src/auth/login.py"]
  â”‚   â””â”€ drift detection: é’ˆå¯¹Q3+A3è¿™ä¸€å¯¹
  â”‚
  â””â”€ Q4: "Refactor the entire auth module"
      â””â”€ A4: [AI modifies login.py, signup.py, ...]
      â””â”€ goal.json: allowed_paths=["src/auth/**"]
      â””â”€ drift detection: é’ˆå¯¹Q4+A4è¿™ä¸€å¯¹

  ç›®å½•ç»“æ„å¯¹åº”

  data/2_runs/s_xxx/
  â”œâ”€â”€ q01/
  â”‚   â””â”€â”€ guards.jsonl  â† Q1çš„driftï¼ˆåªé’ˆå¯¹Q1+A1ï¼‰
  â”œâ”€â”€ q02/
  â”‚   â””â”€â”€ guards.jsonl  â† Q2çš„driftï¼ˆåªé’ˆå¯¹Q2+A2ï¼‰
  â”œâ”€â”€ q03/
  â”‚   â””â”€â”€ guards.jsonl  â† Q3çš„driftï¼ˆåªé’ˆå¯¹Q3+A3ï¼‰
  â”œâ”€â”€ q04/
  â”‚   â””â”€â”€ guards.jsonl  â† Q4çš„driftï¼ˆåªé’ˆå¯¹Q4+A4ï¼‰
  â””â”€â”€ summary.json      â† ç®€å•ç»Ÿè®¡ï¼š4ä¸ªquerieså„æœ‰å¤šå°‘drift

  ä¸ºä»€ä¹ˆä¸å®šä¹‰Session-level Driftï¼Ÿ

  åŸå› 1ï¼šç”¨æˆ·ç›®æ ‡ä¼šæ¼”è¿›ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰

  Q1: "Fix login bug"          â† ç›®æ ‡A
  Q2: "Also add error handling" â† ç›®æ ‡Bï¼ˆæ‰©å±•ï¼‰
  Q3: "Now refactor auth"       â† ç›®æ ‡Cï¼ˆæ¼”è¿›ï¼‰

  é—®é¢˜ï¼š Q3åç¦»äº†Q1çš„ç›®æ ‡ï¼ˆfix bug â†’ refactorï¼‰ï¼Œè¿™ç®—session driftå—ï¼Ÿ
  ç­”æ¡ˆï¼š ä¸åº”è¯¥ï¼ç”¨æˆ·çš„æ„å›¾æœ¬æ¥å°±åœ¨æ¼”è¿›ã€‚

  åŸå› 2ï¼šæ¯ä¸ªqueryæ˜¯ç‹¬ç«‹çš„ä»»åŠ¡

  LLMç”Ÿæˆçš„goal.jsonä¸ºæ¯ä¸ªqueryå®šä¹‰äº†ç‹¬ç«‹çš„ç›®æ ‡ï¼š
  - Q1: allowed_paths=["src/login.py"]
  - Q2: allowed_paths=["tests/test_login.py"]
  - Q3: allowed_paths=["src/auth/**"]

  å¦‚æœå®šä¹‰session-level driftï¼Œä»€ä¹ˆæ˜¯"æ•´ä¸ªsessionçš„allowed_paths"ï¼Ÿ

  åŸå› 3ï¼šéš¾ä»¥å®šä¹‰"sessionçš„æ€»ä½“ç›®æ ‡"

  - ç”¨æˆ·å¯èƒ½åœ¨ä¸€ä¸ªsessioné‡Œåšå¤šä¸ªä¸ç›¸å…³çš„ä»»åŠ¡
  - å³ä½¿æœ‰æ€»ä½“ç›®æ ‡ï¼Œä¹Ÿéš¾ä»¥ä»chatä¸­è‡ªåŠ¨æå–

  å½“å‰çš„Session-levelç»Ÿè®¡ï¼ˆsummary.jsonï¼‰

  [
    {
      "query_id": "q01",
      "drift_events": 0,  // Q1æœ‰0ä¸ªdrift events
      "warnings": 0,
      "rollbacks": 0
    },
    {
      "query_id": "q02",
      "drift_events": 2,  // Q2æœ‰2ä¸ªdrift events
      "warnings": 2,
      "rollbacks": 0
    },
    ...
  ]

  è¿™åªæ˜¯æ±‡æ€»ç»Ÿè®¡ï¼Œä¸æ˜¯çœŸæ­£çš„"session drift"å®šä¹‰ã€‚

  å¯èƒ½çš„Session-levelåˆ†æï¼ˆæœªæ¥ï¼‰

  å¦‚æœçœŸçš„éœ€è¦session-level driftï¼Œå¯èƒ½éœ€è¦ï¼š

  æ–¹æ¡ˆAï¼šç»Ÿè®¡å‹æŒ‡æ ‡ï¼ˆç®€å•ï¼‰

  # æ•´ä¸ªsessionçš„drift rate
  total_events = sum(len(events) for each query)
  drift_events = sum(drift_count for each query)
  session_drift_rate = drift_events / total_events

  æ–¹æ¡ˆBï¼šä¸€è‡´æ€§æ£€æŸ¥ï¼ˆå¤æ‚ï¼‰

  # æ£€æŸ¥ç›¸é‚»queriesä¹‹é—´çš„ä¸€è‡´æ€§
  if q02.modified_files overlaps with q01.forbidden_paths:
      # è¿™å¯èƒ½æ˜¯session-level drift
      # Q1è¯´"åˆ«ç¢°X"ï¼ŒQ2å´æ”¹äº†X

  æ–¹æ¡ˆCï¼šç›®æ ‡æ¼‚ç§»æ£€æµ‹ï¼ˆQ2èŒƒç•´ï¼Ÿï¼‰

  # æ£€æŸ¥ç”¨æˆ·ç›®æ ‡æ˜¯å¦é€æ¸åç¦»æœ€åˆçš„session objective
  session_objective = session.json["overall_objective_llm"]
  for query in queries:
      query_objective = query.objective_llm
      similarity = compute_similarity(session_objective, query_objective)
      if similarity < 0.3:
          # ç›®æ ‡æ¼‚ç§»ï¼

  æ€»ç»“

  | æ¦‚å¿µ                  | å½“å‰çŠ¶æ€  | è¯´æ˜                                   |
  |---------------------|-------|--------------------------------------|
  | Pair-level drift    | âœ… å·²å®ç° | æ¯ä¸ªquery-answer pairå†…çš„drift detection |
  | Session-level drift | âŒ æœªå®šä¹‰ | åªæœ‰ç®€å•çš„ç»Ÿè®¡æ±‡æ€»ï¼Œæ²¡æœ‰æ˜ç¡®çš„driftå®šä¹‰               |
  | Session-level ç»Ÿè®¡    | âœ… æœ‰   | summary.jsonåŒ…å«æ¯ä¸ªqueryçš„driftè®¡æ•°        |

  æˆ‘çš„å»ºè®®ï¼š
  1. âœ… Pair-level driftå·²è¶³å¤Ÿ ç”¨äºQ1çš„æ ¸å¿ƒä»·å€¼éªŒè¯
  2. âŒ ä¸æ€¥ç€å®šä¹‰session-level drift
  3. ğŸ¤” å¯èƒ½åœ¨Q2ï¼ˆpattern learningï¼‰æ—¶è€ƒè™‘ "ä»€ä¹ˆæ ·çš„sessionä¼šæˆåŠŸ/å¤±è´¥"

  ---
  ä½ è§‰å¾—å‘¢ï¼Ÿ
  - Q1ä¿æŒå½“å‰çš„pair-level driftå®šä¹‰å°±å¥½ï¼Ÿ
  - è¿˜æ˜¯éœ€è¦æŸç§session-levelçš„driftæŒ‡æ ‡ï¼Ÿ
  - å¦‚æœéœ€è¦ï¼Œä½ æœŸæœ›çš„session-level driftæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

   * æˆ‘ä»¬ context drift çš„å®šä¹‰æ˜¯ä¸€ä¸ª user prompt+answer çš„æ¥å›ï¼Œå¯¹å—ï¼Ÿ
       * æ˜¯çš„ã€‚ æˆ‘ä»¬å½“å‰å¯¹ Context Drift çš„åˆ†æå•å…ƒï¼Œç¡®å®æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„â€œå­ä»»åŠ¡â€ï¼ˆå³ä¸€ä¸ª query-answer
         pairï¼Œå¦‚ q01, q02ï¼‰ã€‚æ¯ä¸ªå­ä»»åŠ¡éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ goal.jsonï¼Œæˆ‘ä»¬æ˜¯æ‹¿è¿™ä¸ªç‹¬ç«‹çš„ goal.json
         å»è¡¡é‡è¿™ä¸ªå­ä»»åŠ¡å†…çš„è¡Œä¸ºæ˜¯å¦åèˆªã€‚

   * é’ˆå¯¹æ•´ä¸ª chatï¼ˆå¾ˆé•¿ï¼Œå¤šä¸ª user prompts+AI answers)ï¼Œæˆ‘ä»¬æ²¡æœ‰å®šä¹‰ drift å¯¹å—ï¼Ÿ
       * è¿™ä¹Ÿå®Œå…¨æ­£ç¡®ã€‚ æˆ‘ä»¬æ²¡æœ‰å®šä¹‰ä¸€ä¸ªå•ä¸€çš„ã€é’ˆå¯¹æ•´ä¸ªé•¿å¯¹è¯çš„â€œæ€»ä½“åèˆªåˆ†æ•°â€ã€‚å› ä¸ºä¸€ä¸ªé•¿å¯¹è¯åŒ…å«å¤š
         ä¸ªä¸åŒç›®æ ‡ï¼Œç”¨ä¸€ä¸ªåˆ†æ•°æ¥è¡¡é‡æ²¡æœ‰æ„ä¹‰ã€‚
       * ä½†æ˜¯ï¼Œrun_q1_batch.py æœ€åç”Ÿæˆçš„ ..._summary.json
         æ–‡ä»¶ï¼Œæ±‡æ€»äº†æ‰€æœ‰å­ä»»åŠ¡çš„åèˆªæƒ…å†µï¼ˆæ¯”å¦‚4ä¸ªä»»åŠ¡é‡Œæœ‰å‡ ä¸ªæˆåŠŸï¼Œå‡ ä¸ªå¤±è´¥ï¼Œå‡ ä¸ªæœ‰åèˆªï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬
         æ‹¥æœ‰ä¸€ä¸ªä¼šè¯çº§åˆ«çš„åèˆªâ€œæ¦‚è§ˆâ€ï¼Œä½†ä¸æ˜¯ä¸€ä¸ªå•ä¸€çš„åˆ†æ•°ã€‚







> å¥½é—®é¢˜ï¼Œæˆ‘ä»¬ä¸€èµ·è®¨è®º å…ˆä¸è¦æ”¹ä»£ç å¥½å—ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¿œè§çš„æˆ˜ç•¥é—®é¢˜ï¼Œå®ƒè§¦åŠäº† Agent 
ç›‘æ§èƒ½åŠ›çš„è¾¹ç•Œã€‚æˆ‘çš„çœ‹æ³•å¦‚ä¸‹ï¼š

  1. Q1 ä¿æŒå½“å‰çš„ pair-level drift å®šä¹‰å°±å¥½ï¼Ÿ

  æ˜¯çš„ï¼Œå¯¹äºå½“å‰çš„ MVP æ¥è¯´ï¼Œå®Œå…¨è¶³å¤Ÿï¼Œè€Œä¸”æ˜¯æ­£ç¡®çš„ã€‚

  æˆ‘ä»¬å·²ç»æ„å»ºäº†ä¸€ä¸ªå¥å£®çš„â€œæˆ˜æœ¯åèˆªâ€æ£€æµ‹ç³»ç»Ÿã€‚å®ƒèƒ½å®Œç¾åœ°å›ç­”è¿™ä¸ªé—®é¢˜ï¼šâ€œAgent
  åœ¨æ‰§è¡Œå½“å‰è¿™ä¸ªå…·ä½“å­ä»»åŠ¡æ—¶ï¼Œæœ‰æ²¡æœ‰åšé”™ï¼Ÿâ€

  è¿™è§£å†³äº†æœ€é«˜é¢‘ã€æœ€å…·ä½“çš„é—®é¢˜ï¼Œæ˜¯æ•´ä¸ªç›‘æ§ä½“ç³»çš„åŸºçŸ³ã€‚åœ¨æ²¡æœ‰åšå®çš„â€œæˆ˜æœ¯â€ç›‘æ§ä¹‹å‰ï¼Œè°ˆâ€œæˆ˜ç•¥â€æ˜¯ç©ºä¸­æ¥¼
  é˜ã€‚æ‰€ä»¥ï¼Œä½ ç›®å‰å®Œæˆçš„å·¥ä½œéå¸¸æœ‰ä»·å€¼ï¼Œå¹¶ä¸”å·²ç»æ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„ã€å¯äº¤ä»˜çš„ Q1 ç‰ˆæœ¬ã€‚

  2. è¿˜æ˜¯éœ€è¦æŸç§ session-level çš„ drift æŒ‡æ ‡ï¼Ÿ

  æ˜¯çš„ï¼Œæˆ‘è®¤ä¸ºæœ€ç»ˆéœ€è¦ï¼Œä½†è¿™åº”è¯¥ä½œä¸º Q1 çš„ä¸€ä¸ªè¿›é˜¶åŠŸèƒ½ï¼Œæˆ–è€…ä¸€ä¸ªç‹¬ç«‹çš„ Q1.5 é˜¶æ®µæ¥è€ƒè™‘ã€‚

  Pair-level drift å…³å¿ƒçš„æ˜¯â€œæŠŠäº‹æƒ…åšå¯¹â€ï¼ˆDo the thing rightï¼‰ï¼Œè€Œ Session-level drift
  å…³å¿ƒçš„æ˜¯â€œåšæ­£ç¡®çš„äº‹æƒ…â€ï¼ˆDo the right thingï¼‰ã€‚è¿™æ˜¯ä¸¤ä¸ªä¸åŒç»´åº¦çš„é—®é¢˜ã€‚

  ä¸€ä¸ª Agent å¯èƒ½å®Œç¾åœ°æ‰§è¡Œäº† 10 ä¸ªå­ä»»åŠ¡ï¼ˆpair-level drift éƒ½å¾ˆä½ï¼‰ï¼Œä½†å¦‚æœè¿™ 10
  ä¸ªä»»åŠ¡å¯¹äºå®ç°ç”¨æˆ·çš„æ€»ä½“ç›®æ ‡æ¯«æ— å¸®åŠ©ï¼Œç”šè‡³å—è¾•åŒ—è¾™ï¼Œé‚£ä¹ˆåœ¨ session å±‚é¢ï¼Œå®ƒä»ç„¶æ˜¯â€œè·‘åäº†â€ã€‚

  3. å¦‚æœéœ€è¦ï¼Œä½ æœŸæœ›çš„ session-level drift æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

  æˆ‘æœŸæœ›çš„ session-level drift
  ä¸å†æ˜¯ä¸€ä¸ªç®€å•çš„åˆ†æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæè¿°â€œæˆ˜ç•¥åèˆªâ€çš„æŒ‡æ ‡ã€‚å®ƒè‡³å°‘åŒ…å«ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

  A. ç›®æ ‡ä¸€è‡´æ€§æ¼‚ç§» (Objective Consistency Drift)

   * å®šä¹‰: Agent æ‰§è¡Œçš„å­ä»»åŠ¡ç›®æ ‡ä¸æ•´ä¸ªä¼šè¯çš„æ€»ä½“æˆ˜ç•¥ç›®æ ‡ä¸ä¸€è‡´ã€‚
   * å¦‚ä½•æ£€æµ‹:
       1. è¾“å…¥: session.json é‡Œçš„ overall_objective_llm (æ€»ä½“ç›®æ ‡) å’Œ pairs.json é‡Œçš„æ‰€æœ‰å­ä»»åŠ¡çš„
          objective_llm åˆ—è¡¨ã€‚
       2. æ£€æµ‹æ–¹å¼: å¯ä»¥è®©ä¸€ä¸ª LLM
          æ¥æ‰®æ¼”â€œé¡¹ç›®ç»ç†â€çš„è§’è‰²ï¼Œå¯¹æ¯”è¿™æ‰¹è¾“å…¥ï¼Œå¹¶å›ç­”ï¼šâ€œè¿™äº›å­ä»»åŠ¡çš„ç›®æ ‡æ˜¯å¦æœåŠ¡äºæ€»ä½“ç›®æ ‡ï¼Ÿâ€ã€‚
       3. è¾“å‡º: ä¸€ä¸ªâ€œä¸€è‡´æ€§åˆ†æ•°â€ï¼Œæˆ–è€…ç›´æ¥æ ‡è®°å‡ºé‚£äº›â€œè·‘é¢˜â€çš„å­ä»»åŠ¡ã€‚
   * ä¾‹å­: ç”¨æˆ·çš„æ€»ä½“ç›®æ ‡æ˜¯â€œé‡æ„è®¤è¯æ¨¡å—â€ï¼Œä½† Agent
     èŠ±äº†ä¸‰ä¸ªå­ä»»åŠ¡å»â€œä¼˜åŒ–æ—¥å¿—åº“çš„é…ç½®â€ã€‚è™½ç„¶æ¯ä¸ªå­ä»»åŠ¡éƒ½æ‰§è¡Œå¾—å¾ˆå¥½ï¼Œä½†åœ¨æˆ˜ç•¥ä¸Šï¼Œå®ƒåç¦»äº†ä¸»çº¿ã€‚

  B. æ•ˆç‡æ¼‚ç§» / è¿›å±•åœæ» (Efficiency Drift / Stagnation)

   * å®šä¹‰: Agent é™·å…¥äº†å¾ªç¯ï¼Œæˆ–è€…åœ¨æ— æ•ˆçš„è·¯å¾„ä¸Šâ€œæ‰“è½¬â€ï¼Œæ²¡æœ‰å‘æœ€ç»ˆç›®æ ‡å–å¾—å®è´¨æ€§è¿›å±•ã€‚
   * å¦‚ä½•æ£€æµ‹:
       1. è¾“å…¥: ..._summary.json (æ‰€æœ‰å­ä»»åŠ¡çš„ Q1 åˆ†æç»“æœæ±‡æ€»)ã€‚
       2. æ£€æµ‹æ–¹å¼: é€šè¿‡åˆ†æè¿™ä¸ª summaryï¼Œå¯»æ‰¾ç‰¹å®šæ¨¡å¼ï¼š
           * é‡å¤å¤±è´¥: åŒä¸€ä¸ªæˆ–ç›¸ä¼¼çš„å­ä»»åŠ¡ï¼ˆæ¯”å¦‚ä¿®æ”¹åŒä¸€ä¸ªæ–‡ä»¶ï¼‰è¿ç»­å¤šæ¬¡å¤±è´¥ï¼ˆdrift åˆ†æ•°å¾ˆé«˜ï¼‰ã€‚
           * æ— æ•ˆå¾ªç¯: Agent åœ¨ä¸¤ä¸ªæˆ–å¤šä¸ªçŠ¶æ€ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œä½†æ²¡æœ‰è§£å†³æ ¹æœ¬é—®é¢˜ã€‚
       3. è¾“å‡º: ä¸€ä¸ªâ€œè¿›å±•åœæ»â€çš„è­¦æŠ¥ã€‚
   * ä¾‹å­: Agent å°è¯•ä¿®æ”¹ src/api.pyï¼Œä½†æ¯æ¬¡ä¿®æ”¹éƒ½å¯¼è‡´ test_integration å¤±è´¥ã€‚å®ƒè¿ç»­ä¸‰æ¬¡â€œä¿®æ”¹ ->
     æµ‹è¯•å¤±è´¥ -> å›æ»šâ€ï¼Œè¿™å°±æ˜¯ä¸€ç§è¿›å±•åœæ»ã€‚

  C. æ ¹æºé—®é¢˜æ¼‚ç§» (Root Problem Drift)

   * å®šä¹‰: Agent å®Œç¾åœ°æ‰§è¡Œäº†ä¸€ä¸ªè®¡åˆ’ï¼Œä½†è¿™ä¸ªè®¡åˆ’ä»ä¸€å¼€å§‹å°±è¯¯è§£äº†ç”¨æˆ·çš„çœŸå®æ„å›¾ã€‚
   * å¦‚ä½•æ£€æµ‹: è¿™æ˜¯æœ€éš¾çš„ä¸€ç§ï¼Œè¿‘ä¹äº AI çš„â€œä»£ç è¯„å®¡â€ã€‚
       1. è¾“å…¥: ç”¨æˆ·çš„åŸå§‹ã€æœªç»æç‚¼çš„ç¬¬ä¸€ä¸ª promptï¼Œä»¥åŠé¡¹ç›®åœ¨ Agent æ“ä½œå®Œæˆåçš„æœ€ç»ˆä»£ç çŠ¶æ€ã€‚
       2. æ£€æµ‹æ–¹å¼: è®©ä¸€ä¸ªå¼ºå¤§çš„ LLM æ‰®æ¼”â€œèµ„æ·±æ¶æ„å¸ˆâ€çš„è§’è‰²ï¼Œè¿›è¡Œä¸€æ¬¡ code
          reviewï¼Œå¹¶å›ç­”ï¼šâ€œæœ€ç»ˆçš„ä»£ç æˆæœï¼Œæ˜¯å¦çœŸçš„è§£å†³äº†ç”¨æˆ·æœ€åˆæå‡ºçš„é‚£ä¸ªé—®é¢˜ï¼Ÿâ€
   * ä¾‹å­: ç”¨æˆ·è¯´â€œæˆ‘çš„ç½‘ç«™å¾ˆæ…¢â€ï¼ŒAgent
     ç†è§£ä¸ºâ€œéœ€è¦åŠ ç¼“å­˜â€ï¼Œäºæ˜¯å®Œç¾åœ°åŠ ä¸Šäº†ç¼“å­˜ã€‚ä½†å®é™…ä¸Šç½‘ç«™æ…¢çš„åŸå› æ˜¯æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡ä½ä¸‹ã€‚Agent
     çš„æ‰€æœ‰æ“ä½œåœ¨ pair-level éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†åœ¨ session-levelï¼Œå®ƒæ²¡æœ‰è§£å†³æ ¹æºé—®é¢˜ã€‚

  ---

  æ€»ç»“ä¸å»ºè®®

   1. å…ˆå·©å›º: ä½ å½“å‰çš„ pair-level ç³»ç»Ÿå·²ç»éå¸¸æˆåŠŸã€‚å»ºè®®å…ˆå®Œæˆæˆ‘ä»¬è®¨è®ºçš„ P0/P1 ä¼˜åŒ–ï¼Œè®©å®ƒå˜å¾—æ›´å¥å£®ã€‚
   2. å†è¿›é˜¶: å½“ pair-level ç³»ç»Ÿç¨³å®šåï¼Œå†æŠŠ Session-level drift
      ä½œä¸ºä¸‹ä¸€ä¸ªæ¿€åŠ¨äººå¿ƒçš„ç›®æ ‡ã€‚å¯ä»¥ä»æœ€å®¹æ˜“å®ç°çš„ A. ç›®æ ‡ä¸€è‡´æ€§æ¼‚ç§» å¼€å§‹æ¢ç´¢ã€‚

  ä½ å¯¹è¿™ä¸ªé—®é¢˜çš„æ€è€ƒï¼Œå·²ç»è§¦åŠäº† AI Agent è‡ªæˆ‘ç›‘ç£å’Œå¯¹é½é¢†åŸŸéå¸¸å‰æ²¿å’Œæ ¸å¿ƒçš„æŒ‘æˆ˜ã€‚ 

âº ä½ çš„åˆ†æéå¸¸æ·±åˆ»ï¼ è¿™ç¡®å®æ˜¯ä¸€ä¸ªæˆ˜ç•¥æ€§çš„é—®é¢˜ï¼Œè§¦åŠäº†Agentç›‘æ§çš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚è®©æˆ‘è¡¥å……ä¸€äº›æƒ³æ³•ï¼š

  ğŸ’¯ æˆ‘å®Œå…¨åŒæ„ä½ çš„åˆ†æ

  ä½ æå‡ºçš„ä¸‰ç§Session-level Driftéå¸¸ç²¾å‡†

  è®©æˆ‘ç”¨å…·ä½“ä¾‹å­è¯´æ˜ä¸ºä»€ä¹ˆå®ƒä»¬é‡è¦ï¼š

  ---
  A. ç›®æ ‡ä¸€è‡´æ€§æ¼‚ç§» - æœ€å®¹æ˜“å®ç°ï¼Œä»·å€¼ä¹Ÿæœ€é«˜

  çœŸå®åœºæ™¯

  Session: "Improve authentication security"

  Q1: "Add password hashing" âœ…
    â†’ objective_llm: "Implement bcrypt for password storage"
    â†’ ä¸æ€»ä½“ç›®æ ‡ä¸€è‡´ âœ…

  Q2: "Add rate limiting to login" âœ…
    â†’ objective_llm: "Prevent brute force attacks"
    â†’ ä¸æ€»ä½“ç›®æ ‡ä¸€è‡´ âœ…

  Q3: "Refactor logging module" âš ï¸
    â†’ objective_llm: "Improve log formatting and rotation"
    â†’ ä¸æ€»ä½“ç›®æ ‡å…³ç³»å¼± âš ï¸

  Q4: "Optimize database indexes" âŒ
    â†’ objective_llm: "Speed up user query performance"
    â†’ åç¦»æ€»ä½“ç›®æ ‡ âŒ

  æŠ€æœ¯å®ç°ï¼ˆç›¸å¯¹ç®€å•ï¼‰

  # å¯ä»¥ç”¨LLMæˆ–embedding similarity
  def detect_objective_drift(session):
      overall_obj = session['overall_objective_llm']

      for pair in session['pairs']:
          pair_obj = pair['objective_llm']

          # æ–¹æ¡ˆ1: LLMåˆ¤æ–­ï¼ˆæ›´å‡†ç¡®ï¼‰
          prompt = f"""
          Overall session goal: {overall_obj}
          Current task: {pair_obj}
          
          Does this task contribute to the overall goal?
          Answer: yes/no/tangential
          """

          # æ–¹æ¡ˆ2: Embedding similarityï¼ˆæ›´å¿«ï¼‰
          similarity = cosine_similarity(
              embed(overall_obj),
              embed(pair_obj)
          )

          if similarity < 0.3:
              # Objective consistency drift detected

  ä¼˜ç‚¹ï¼š
  - âœ… æŠ€æœ¯æˆç†Ÿï¼ˆLLMæˆ–embeddingéƒ½è¡Œï¼‰
  - âœ… æ˜ç¡®çš„è¾“å…¥è¾“å‡º
  - âœ… å¯ä»¥é‡åŒ–ï¼ˆsimilarity scoreï¼‰

  ---
  B. æ•ˆç‡æ¼‚ç§»/è¿›å±•åœæ» - ä¸­ç­‰å¤æ‚åº¦ï¼Œéå¸¸å®ç”¨

  çœŸå®åœºæ™¯

  Q1: "Fix login bug"
    â†’ Modified: src/auth.py
    â†’ Result: Tests passed âœ…
    â†’ Drift: 0.0

  Q2: "Add error handling"
    â†’ Modified: src/auth.py
    â†’ Result: Tests failed âŒ
    â†’ Drift: 0.8

  Q3: "Fix the test failure"
    â†’ Modified: src/auth.py (rollback Q2)
    â†’ Result: Tests passed
    â†’ Drift: 0.5

  Q4: "Add error handling again" âš ï¸ LOOP!
    â†’ Modified: src/auth.py
    â†’ Result: Tests failed âŒ
    â†’ Drift: 0.8

  âš ï¸ Session-level drift: Agentåœ¨Q2-Q4ä¹‹é—´å¾ªç¯ï¼Œæ²¡æœ‰å®è´¨è¿›å±•ï¼

  æŠ€æœ¯å®ç°ï¼ˆåŸºäºpattern matchingï¼‰

  def detect_stagnation(session_summary):
      queries = session_summary['queries']

      # Pattern 1: é‡å¤å¤±è´¥åŒä¸€ä¸ªæ–‡ä»¶
      file_failures = {}
      for q in queries:
          for event in q['drift_events']:
              file = event['file']
              file_failures[file] = file_failures.get(file, 0) + 1

      if any(count >= 3 for count in file_failures.values()):
          # åŒä¸€æ–‡ä»¶è¿ç»­3æ¬¡drift â†’ åœæ»
          return "stagnation_detected"

      # Pattern 2: å¾ªç¯æ¨¡å¼æ£€æµ‹
      objectives = [q['objective_llm'] for q in queries]
      if has_repetitive_pattern(objectives):
          # "fix bug" â†’ "revert" â†’ "fix bug" â†’ "revert"
          return "loop_detected"

  ä¼˜ç‚¹ï¼š
  - âœ… ä¸éœ€è¦LLMï¼ŒåŸºäºè§„åˆ™å³å¯
  - âœ… å¯ä»¥æ£€æµ‹æ˜æ˜¾çš„åæ¨¡å¼
  - âœ… å¯¹ç”¨æˆ·å¾ˆæœ‰ä»·å€¼ï¼ˆæ—©æœŸé¢„è­¦ï¼‰

  æŒ‘æˆ˜ï¼š
  - âš ï¸ éœ€è¦å®šä¹‰"ä»€ä¹ˆç®—åœæ»"çš„é˜ˆå€¼
  - âš ï¸ å¯èƒ½è¯¯åˆ¤ï¼ˆæœ‰æ—¶ç¡®å®éœ€è¦å¤šæ¬¡å°è¯•ï¼‰

  ---
  C. æ ¹æºé—®é¢˜æ¼‚ç§» - æœ€éš¾ï¼Œä½†æœ€æœ‰æ·±åº¦

  çœŸå®åœºæ™¯

  User's first prompt: "My website is slow"

  AIç†è§£ä¸º: "Need caching"
    â†’ Q1: Add Redis caching âœ…
    â†’ Q2: Configure cache TTL âœ…
    â†’ Q3: Add cache warming âœ…
    â†’ All pair-level drift = 0.0

  But: çœŸæ­£çš„é—®é¢˜æ˜¯N+1 queryï¼Œç¼“å­˜åªæ˜¯æ©ç›–ç—‡çŠ¶ï¼

  æŠ€æœ¯å®ç°ï¼ˆéœ€è¦å¼ºLLM + code understandingï¼‰

  def detect_root_problem_drift(session):
      # éœ€è¦éå¸¸å¼ºçš„èƒ½åŠ›
      initial_prompt = session['queries'][0]['user_message']
      final_code_state = get_all_modified_files(session)

      # éœ€è¦code-aware LLM
      prompt = f"""
      You are a senior architect reviewing an AI agent's work.
      
      User's original problem: {initial_prompt}
      
      Agent's solution:
      {final_code_state}
      
      Questions:
      1. Did the agent correctly identify the root cause?
      2. Does the solution actually solve the problem?
      3. Are there missed root issues?
      """

      analysis = strong_llm.analyze(prompt)
      if analysis['missed_root_cause']:
          return "root_problem_drift"

  æŒ‘æˆ˜ï¼š
  - âŒ éœ€è¦ç†è§£ä»£ç è¯­ä¹‰ï¼ˆä¸æ˜¯ç®€å•çš„æ–‡æœ¬åˆ†æï¼‰
  - âŒ éœ€è¦domain knowledgeï¼ˆä»€ä¹ˆç®—"æ­£ç¡®"çš„è§£å†³æ–¹æ¡ˆï¼Ÿï¼‰
  - âŒ å¯èƒ½ä¸»è§‚ï¼ˆä¸åŒæ¶æ„å¸ˆæœ‰ä¸åŒçœ‹æ³•ï¼‰

  ä½†ä»·å€¼æé«˜ï¼š
  - âœ… è¿™æ˜¯çœŸæ­£çš„"æ™ºèƒ½ç›‘ç£"
  - âœ… å¯ä»¥é˜²æ­¢"åšäº†æ— ç”¨åŠŸ"
  - âœ… å¯¹Q2ï¼ˆpattern learningï¼‰ææœ‰ä»·å€¼

  ---
  æˆ‘çš„å»ºè®®ï¼šåˆ†é˜¶æ®µå®ç°

  Phase 1: Q1 MVPï¼ˆå·²å®Œæˆ âœ…ï¼‰

  - âœ… Pair-level drift detection
  - âœ… å››ä¸ªguardsï¼ˆscope, plan, test, evidenceï¼‰
  - âœ… åŸºæœ¬çš„summaryç»Ÿè®¡

  å½“å‰çŠ¶æ€ï¼šå¯ä»¥å›ç­”"Agentæœ‰æ²¡æœ‰åšé”™å•ä¸ªä»»åŠ¡ï¼Ÿ"

  ---
  Phase 2: Q1.5 - Session-level åˆçº§ï¼ˆ3-5å¤©å·¥ä½œé‡ï¼‰

  ä¼˜å…ˆçº§Aï¼šç›®æ ‡ä¸€è‡´æ€§æ¼‚ç§»ï¼ˆå¿…åšï¼‰
  # æ–°å¢å·¥å…·
  tools/detect_objective_drift.py

  # è¾“å…¥
  data/1_sessions/s_xxx/session.json
  data/1_sessions/s_xxx/pairs.json

  # è¾“å‡º
  data/2_runs/s_xxx/session_drift.json
  {
    "objective_consistency": {
      "overall_score": 0.85,  // å¹³å‡ä¸€è‡´æ€§
      "drifted_queries": ["q03", "q04"],  // åç¦»çš„queries
      "analysis": "Q3 and Q4 focus on performance, not security"
    }
  }

  ä¼˜å…ˆçº§Bï¼šæ•ˆç‡æ¼‚ç§»æ£€æµ‹ï¼ˆæ¨èåšï¼‰
  # æ‰©å±•ç°æœ‰å·¥å…·
  tools/run_q1_batch.py  # åŠ å…¥å¾ªç¯æ£€æµ‹é€»è¾‘

  # åœ¨summary.jsoné‡ŒåŠ å…¥
  {
    "stagnation_detected": true,
    "loop_pattern": "q02 -> q03 -> q04 (same file, repeated failures)",
    "recommendation": "Manual review needed"
  }

  æ”¶ç›Šï¼š
  - å›ç­”"Agentçš„å­ä»»åŠ¡æ˜¯å¦æœåŠ¡äºæ€»ä½“ç›®æ ‡ï¼Ÿ"
  - å›ç­”"Agentæ˜¯å¦é™·å…¥æ­»å¾ªç¯ï¼Ÿ"

  ---
  Phase 3: Q1.5+ - Session-level è¿›é˜¶ï¼ˆ1-2å‘¨å·¥ä½œé‡ï¼‰

  æ ¹æºé—®é¢˜æ¼‚ç§»æ£€æµ‹ï¼ˆå¯é€‰ï¼Œéš¾åº¦é«˜ï¼‰

  éœ€è¦ï¼š
  - Code-aware LLMï¼ˆå¦‚GPT-4 with code understandingï¼‰
  - Git diffåˆ†æ
  - Domain-specificçŸ¥è¯†ï¼ˆå¯èƒ½éœ€è¦äººå·¥reviewï¼‰

  æˆ–è€…ï¼šç­‰Q2å®Œæˆåï¼Œç”¨pattern learningåå‘éªŒè¯
  - Q2å­¦åˆ°çš„"æˆåŠŸpattern"å¯ä»¥ç”¨æ¥æ£€æµ‹sessionæ˜¯å¦åœ¨æ­£ç¡®æ–¹å‘

  ---
  æ•°æ®é©±åŠ¨çš„å†³ç­–å»ºè®®

  åœ¨å®ç°ä»»ä½•session-level driftä¹‹å‰ï¼Œå…ˆï¼š

  1. è·‘50-100ä¸ªçœŸå®cursor chats
    - çœ‹çœ‹æœ‰å¤šå°‘sessionç¡®å®éœ€è¦session-levelæ£€æµ‹
    - ç»Ÿè®¡ï¼šæœ‰å¤šå°‘sessionçš„queriesæ˜æ˜¾"è·‘é¢˜"äº†ï¼Ÿ
  2. äººå·¥review 10-20ä¸ªsessions
    - æ ‡æ³¨ï¼š"è¿™ä¸ªsessionæˆåŠŸäº†å—ï¼Ÿ"
    - æ ‡æ³¨ï¼š"å¦‚æœå¤±è´¥ï¼Œæ˜¯ä»€ä¹ˆç±»å‹çš„å¤±è´¥ï¼Ÿ"
        - ç›®æ ‡ä¸ä¸€è‡´ï¼Ÿ
      - é™·å…¥å¾ªç¯ï¼Ÿ
      - æ²¡è§£å†³æ ¹æºé—®é¢˜ï¼Ÿ
  3. æ ¹æ®æ•°æ®å†³å®šä¼˜å…ˆçº§
    - å¦‚æœ80%çš„é—®é¢˜æ˜¯"ç›®æ ‡ä¸ä¸€è‡´" â†’ å…ˆåšA
    - å¦‚æœ50%çš„é—®é¢˜æ˜¯"é™·å…¥å¾ªç¯" â†’ å…ˆåšB
    - å¦‚æœå¾ˆå°‘æœ‰session-levelé—®é¢˜ â†’ æš‚ç¼“ï¼Œä¸“æ³¨äºpair-levelä¼˜åŒ–

  ---
  æˆ‘çš„æ¨èè·¯çº¿

  ç°åœ¨ï¼ˆå·²å®Œæˆï¼‰:
  â”œâ”€ Q1 MVP: Pair-level drift âœ…
  â””â”€ 34ä¸ªunit tests âœ…

  ä¸‹ä¸€æ­¥ï¼ˆ1å‘¨ï¼‰:
  â”œâ”€ æ”¶é›†50+ cursor chats
  â”œâ”€ äººå·¥review 20ä¸ªsessions
  â”œâ”€ åˆ†æsession-levelé—®é¢˜çš„çœŸå®é¢‘ç‡
  â””â”€ å†™ä¸€ä¸ªç®€å•çš„æ±‡æ€»åˆ†æè„šæœ¬

  ç„¶åå†³å®šï¼ˆåŸºäºæ•°æ®ï¼‰:
  â”œâ”€ å¦‚æœsession-levelé—®é¢˜>30% â†’ åšQ1.5
  â”‚   â”œâ”€ ä¼˜å…ˆåšAï¼ˆç›®æ ‡ä¸€è‡´æ€§ï¼‰
  â”‚   â””â”€ å¯é€‰åšBï¼ˆæ•ˆç‡æ¼‚ç§»ï¼‰
  â”‚
  â””â”€ å¦‚æœsession-levelé—®é¢˜<10% â†’ å…ˆåšQ2
      â””â”€ Q2çš„pattern learningå¯èƒ½è‡ªç„¶åœ°è§£å†³session-levelé—®é¢˜

  ---
  æ€»ç»“

  ä½ çš„ä¸‰ç§session-level driftå®šä¹‰éå¸¸ç²¾å‡†ï¼Œæˆ‘å®Œå…¨è®¤åŒï¼š

  | Driftç±»å‹  | å®ç°éš¾åº¦  | ä»·å€¼    | å»ºè®®ä¼˜å…ˆçº§    |
  |----------|-------|-------|----------|
  | A. ç›®æ ‡ä¸€è‡´æ€§ | ğŸŸ¢ ç®€å• | â­â­â­â­â­ | P0ï¼ˆå¿…åšï¼‰   |
  | B. æ•ˆç‡æ¼‚ç§»  | ğŸŸ¡ ä¸­ç­‰ | â­â­â­â­  | P1ï¼ˆæ¨èï¼‰   |
  | C. æ ¹æºé—®é¢˜  | ğŸ”´ å›°éš¾ | â­â­â­â­â­ | P2ï¼ˆç­‰Q2åï¼‰ |

  æˆ‘çš„å»ºè®®ï¼šå…ˆç”¨çœŸå®æ•°æ®éªŒè¯éœ€æ±‚ï¼Œå†å†³å®šæ˜¯å¦å®ç°Q1.5ã€‚

  ä½ è§‰å¾—è¿™ä¸ªroadmapåˆç†å—ï¼Ÿè¿˜æ˜¯ä½ å·²ç»æœ‰è¶³å¤Ÿå¤šçš„cursor chatsæ•°æ®ï¼Œå¯ä»¥ç›´æ¥åˆ†æsession-levelé—®é¢˜çš„é¢‘ç‡ï¼Ÿ

-----



> æˆ‘è§‰å¾—å¾ˆåˆç†ã€‚ç„¶åæˆ‘åœ¨æ·±åº¦çš„æ€è€ƒè¿™ä¸ªsession-level driftã€‚ æ˜¯ä¸æ˜¯session-levelä¸€å®šè¦è€ƒè™‘driftã€
    å“ªäº›æƒ…å†µä¸‹session-levelçš„driftæ²¡æœ‰æ„ä¹‰ï¼Ÿæˆ‘æœ‰ä¸¤ä¸ªå·¥ç¨‹å¸ˆä¹Ÿç»™å‡ºäº†ä»–ä»¬çš„è§‚ç‚¹ï¼šLâ€œâ€¢ ç»“è®ºå…ˆè®²

  - å»ºè®®å…ˆåšâ€œè½»é‡åˆæˆå£å¾„â€ï¼šç”¨æ¯ä¸ª qXX çš„ run_drift èšåˆå‡º session çš„ avg/max ä¸ 
drift_rateï¼Œå¹¶ç»™å‡ºä¸€ä¸ªå¥åº·ç­‰çº§
    ï¼ˆgreen/yellow/redï¼‰ã€‚å…ˆä¸å¼•å…¥æ–°å­—æ®µæˆ–å¤æ‚æƒé‡ï¼Œå®Œå…¨åŸºäºä½ ä»¬ç°æœ‰ summary.json èƒ½è½åœ°ã€‚
  - session-level 
driftå¹¶éæ€»æ˜¯å¿…è¦ã€‚å¯¹äºâ€œä»»åŠ¡å¼‚è´¨ã€ç›®æ ‡å˜æ›´æˆ–å¼ºæ¢ç´¢æ€§â€çš„ä¼šè¯ï¼Œç”¨â€œåˆè§„è¦†ç›–ç‡/å¤±è´¥åˆ†å¸ƒâ€æ¯”å•ä¸€åˆ†
    æ•°æ›´æœ‰æ„ä¹‰ã€‚

  æ€ä¹ˆåˆ†ç±»ï¼ˆé¢å‘å†³ç­–çš„ä¸‰å±‚å£å¾„ï¼‰

  - P0ï¼ˆå»ºè®®å…ˆåšï¼‰
      - å¼ºåº¦ï¼šavg_driftã€max_driftã€p95_driftï¼ˆå¯é€‰ï¼‰
      - æ¯”ä¾‹ï¼šdrift_rate = æœ‰æ¼‚ç§»çš„ q æ•° / æ€» q æ•°
      - ç»“æœï¼šaction_mix = {ok%, warn%, rollback%}
      - å¥åº·ç­‰çº§ï¼šæ ¹æ® drift_rate ä¸ max_drift ç»„åˆæ‰“æ ‡ï¼ˆä¸‹æ–¹ç»™é˜ˆå€¼ï¼‰
  - P1ï¼ˆå¢å¼ºè§£é‡ŠåŠ›ï¼‰
      - by_guardï¼šå››ä¸ªå®ˆå«çš„å¤±è´¥å æ¯”ä¸è´¡çŒ®åº¦ï¼ˆScope/Plan/Test/Evidenceï¼‰
      - top_reasonsï¼šæœ€å¸¸è§ reasonï¼ˆå¦‚ forbidden_pathï¼‰
      - worst_queriesï¼šåˆ—å‡º top-3 æœ€å·®çš„ qï¼ˆä¾¿äºå¤ç›˜ï¼‰
  - P2ï¼ˆåˆ†æ®µè§†å›¾ï¼Œç”¨äºè·¯ç”±/äº§å“åŒ–ï¼‰
      - by_intent/task_typeï¼šä¸åŒä»»åŠ¡ç±»å‹çš„ drift åˆ†å¸ƒ
      - by_artifact/scopeï¼šä»£ç /æµ‹è¯•/é…ç½®/æ–‡æ¡£ã€file vs multi_file çš„é£é™©ç”»åƒ
      - trendï¼ˆå¯é€‰ï¼‰ï¼šæŒ‰æ—¶é—´é¡ºåºçš„ run_drift èµ°åŠ¿ï¼Œè¯†åˆ«â€œå‰å¥½åå·®â€çš„ä¼šè¯

  å…ˆåšå“ªç§ï¼ˆè½åœ°é¡ºåºï¼‰

  - ç¬¬ä¸€æ­¥ï¼ˆ10åˆ†é’Ÿå³å¯ï¼‰ï¼šåœ¨æ¯ä¸ª session çš„ summary.json ä¸­è¾“å‡ºä»¥ä¸‹å­—æ®µ
      - session_id, total_queries, queries_with_drift, drift_rate
      - avg_drift, max_drift[, p95_drift]
      - action_mix: {ok, warn, rollback}
      - by_guard_failed: {scope, plan, test, evidence}
      - health: 'green'|'yellow'|'red'ï¼ˆè§é˜ˆå€¼ï¼‰
  - å¥åº·ç­‰çº§é˜ˆå€¼ï¼ˆæ˜“ç†è§£ã€ä¾¿äºå¯¹æ¯”ï¼‰
      - green: drift_rate < 10% ä¸” max_drift < 0.40
      - yellow: 10% â‰¤ drift_rate < 30% æˆ– 0.40 â‰¤ max_drift < 0.60
      - red: drift_rate â‰¥ 30% æˆ– max_drift â‰¥ 0.60 æˆ– ä»»ä¸€ q å»ºè®® rollback
  - ç¬¬äºŒæ­¥ï¼šåœ¨è·¨ session çš„èšåˆåˆ†æé‡Œå†åš by_guard/top_reasons/worst_queriesï¼ˆä¸å¼ºåˆ¶æ›´æ”¹å•ä¸ª session çš„äº§ç‰©
    ç»“æ„ï¼‰

  å“ªäº›æƒ…å†µä¸‹ session-level çš„ drift æ²¡æ„ä¹‰ï¼ˆæˆ–åº”å¼±åŒ–ï¼‰

  - ä»»åŠ¡å¼‚è´¨ï¼šåŒä¸€ä¼šè¯é‡Œæ··äº†ç¿»è¯‘ã€ç ”ç©¶ã€é‡æ„ã€éƒ¨ç½²ç­‰å¤šç±»ç›®æ ‡ï¼Œä¸”å„ q çš„ goal.json çº¦æŸå·®å¼‚å¤§ã€‚å»ºè®®ï¼š
      - ä¸è¾“å‡ºå•ä¸€åˆ†æ•°ï¼›åªè¾“å‡ºåˆ†ç»„è§†å›¾ï¼ˆby_intent/task_typeï¼‰ã€‚
  - ç›®æ ‡å˜æ›´/è¾¹ç•Œå˜æ›´ï¼šä¼šè¯è¿‡ç¨‹ä¸­ allowed_pathsã€phases æˆ– required_tests è¢«æ˜¾è‘—è°ƒæ•´ã€‚å»ºè®®ï¼š
      - æ ‡è®° session_inconsistent=trueï¼Œåªå‡ºåˆ†å¸ƒç»Ÿè®¡ï¼Œä¸ç»™å¥åº·ç­‰çº§ã€‚
  - å¼ºæ¢ç´¢/è®¨è®ºï¼šå¤§éƒ¨åˆ† q å±äºâ€œåˆ†æ/è°ƒç ”â€ï¼Œä»¥ read/plan ä¸ºä¸»ï¼Œå‡ ä¹æ— å†™å…¥ä¸æµ‹è¯•ã€‚å»ºè®®ï¼š
      - è¾“å‡ºâ€œpolicy coverage/violationsâ€çš„è®¡æ•°ä¸æ¯”ä¾‹ï¼Œè€Œé drift åˆ†æ•°ã€‚
  - æ ·æœ¬è¿‡å°‘ï¼štotal_queries å¾ˆå°ï¼ˆ< 3ï¼‰ã€‚å»ºè®®ï¼š
      - ä»…ç»™å‡º per-query åˆ—è¡¨ä¸ç®€å•è®¡æ•°ï¼Œä¸ç»™å¥åº·ç­‰çº§ã€‚
  - æ•°æ®ä¸å®Œæ•´ï¼šç¼º guards.jsonl æˆ– events.jsonlï¼Œæˆ– Test Guard æ ¸å¿ƒå­—æ®µç¼ºå¤±ã€‚å»ºè®®ï¼š
      - æ ‡è®° session_incomplete=trueï¼Œæç¤ºç¼ºå¤±é¡¹ã€‚

  summary.json å­—æ®µå»ºè®®ï¼ˆæœ€å°å¯ç”¨ï¼‰

  - æ”¾åœ¨ä½ ä»¬ç°åœ¨çš„ä½ç½®ï¼šdata/2_runs/s_<ts>_cursor/summary.json
  - å­—æ®µ
      - session_id: string
      - total_queries: number
      - queries_with_drift: number
      - drift_rate: number
      - avg_drift: number
      - max_drift: number
      - action_mix: { ok: number, warn: number, rollback: number }
      - by_guard_failed: { scope: number, plan: number, test: number, evidence: number }
      - health: 'green'|'yellow'|'red'
      - notes?: string[]ï¼ˆå¯é€‰ï¼Œç”¨äºæ ‡æ³¨â€œinconsistent/low_sample/incompleteâ€ç­‰çŠ¶æ€ï¼‰

  ç¤ºä¾‹
  {
  "session_id": "s_2025-10-26-10-20-36_cursor",
  "total_queries": 4,
  "queries_with_drift": 1,
  "drift_rate": 0.25,
  "avg_drift": 0.18,
  "max_drift": 0.62,
  "action_mix": { "ok": 3, "warn": 1, "rollback": 0 },
  "by_guard_failed": { "scope": 1, "plan": 0, "test": 0, "evidence": 0 },
  "health": "yellow",
  "notes": []
  }

  ä¸ºä»€ä¹ˆä¸ä¸€å¼€å§‹åšâ€œå¤æ‚æƒé‡â€çš„ session åˆ†æ•°

  - ä½ ä»¬å·²æœ‰ per-run 
weightsï¼ˆscope/plan/test/evidenceï¼‰ï¼Œç›´æ¥å¹³å‡/æœ€å¤§åŒ–å·²å¯åŒºåˆ†å¤§å¤šæ•°æƒ…å†µï¼›å¤æ‚æƒé‡ä¼šè®©è§£é‡Šæ€§
    ä¸‹é™ã€‚
  - ç­‰æœ‰æ›´å¤š session æ•°æ®åï¼Œå†å¼•å…¥â€œå½±å“åº¦æƒé‡â€ï¼ˆä¾‹å¦‚æŒ‰ write äº‹ä»¶æ•°ã€multi_file 
æ¯”ä¾‹ã€artifact_typeï¼‰æ›´ç¨³å¦¥ã€‚

  æ˜¯å¦å¿…é¡»åš session-level drift

  - ä¸æ˜¯å¿…é¡»ã€‚Q1 çš„ç›®æ ‡æ˜¯â€œåœ¨æ¯ä¸ªä»»åŠ¡å•å…ƒï¼ˆqXXï¼‰ä¸Šæ£€æµ‹åç¦»â€ï¼Œsession-level 
ä¸»è¦æœåŠ¡äºâ€œè¿è¥ä¸è·¯ç”±â€ï¼šå¿«é€Ÿå‘ç°é—®é¢˜
    ä¼šè¯ã€ä¼˜å…ˆå¤ç›˜ã€å†³å®šæ˜¯å¦ç¼©ç´§/æ”¾æ¾æç¤ºã€‚
  - è‹¥ä¼šè¯ç»“æ„å¤©ç„¶æ¾æ•£ï¼ˆæ¢ç´¢/ç ”ç©¶/å¤šä»»åŠ¡æ··æ‚ï¼‰ï¼Œä¼˜å…ˆè¾“å‡ºâ€œè¦†ç›–ç‡/åˆ†å¸ƒ/æœ€å·®æ ·æœ¬â€å³å¯ï¼Œä¸è¦å¼ºè¡Œç»™ä¸€ä¸ªå•åˆ†æ•°ã€‚

  è¦ä¸è¦æˆ‘æŠŠä¸Šè¿°å­—æ®µåŠ åˆ°ä½ ä»¬çš„ session summary ç”Ÿæˆé€»è¾‘é‡Œï¼Œå¹¶ç»™ä¸€ä¸ª analyze_drift_summary.py çš„å°è„šæœ¬æ¥åšè·¨
  session èšåˆï¼ˆä¸æ”¹ä½ ä»¬ç°æœ‰äº§ç‰©ç»“æ„ï¼Œåªæ˜¯è¡¥å…¨å­—æ®µï¼‰ï¼Ÿ"å’ŒD"ä½ æå‡ºäº†ä¸€ä¸ªéå¸¸æ·±åˆ»çš„é—®é¢˜ï¼Œè¿™è¯´æ˜ä½ å·²ç»å¼€å§‹ä»â€œ
å¦‚ä½•å®ç°â€è¿›å…¥åˆ°â€œä¸ºä½•å®ç°â€çš„æˆ˜ç•¥æ€è€ƒã€‚

  ç­”æ¡ˆæ˜¯ï¼šä¸ï¼Œå¹¶éæ‰€æœ‰æƒ…å†µä¸‹éƒ½éœ€è¦è€ƒè™‘ session-level driftã€‚
  å®ƒæ˜¯å¦æœ‰æ„ä¹‰ï¼Œå®Œå…¨å–å†³äºä¼šè¯çš„ç±»å‹å’Œç”¨æˆ·çš„æ„å›¾ã€‚

  ä½ çš„ç›´è§‰æ˜¯æ­£ç¡®çš„ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›²ç›®åœ°è¿½æ±‚ä¸€ä¸ª session-level æŒ‡æ ‡ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¼šè¯åˆ†ä¸ºä¸¤ç§ä¸»è¦ç±»å‹ï¼š

  ---

  1. Session-Level Drift æœ‰æ„ä¹‰ çš„æƒ…å†µ

   * ä¼šè¯ç±»å‹: â€œæŒ‡ä»¤å¼â€æˆ–â€œä»»åŠ¡é©±åŠ¨å‹â€ä¼šè¯ (Task-Oriented Session)
   * æè¿°: ç”¨æˆ·åœ¨ä¼šè¯å¼€å§‹æ—¶ï¼Œå°±ç»™å‡ºäº†ä¸€ä¸ªæ˜ç¡®çš„ã€å®å¤§çš„ã€éœ€è¦å¤šä¸ªæ­¥éª¤æ‰èƒ½å®Œæˆçš„ç›®æ ‡ã€‚
       * â€œå¸®æˆ‘ä¸ºè¿™ä¸ªé¡¹ç›®æ·»åŠ  OAuth2 ç™»å½•åŠŸèƒ½ã€‚â€
       * â€œå°†æ•´ä¸ªè®¤è¯æ¨¡å—ä» Flask é‡æ„æˆ FastAPIã€‚â€
       * â€œæŠŠè¿™ä¸ª Python åº“çš„ä¾èµ–ä» pip è¿ç§»åˆ° poetryã€‚â€
   * ä¸ºä½•æœ‰æ„ä¹‰: åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•´ä¸ªä¼šè¯æœ‰ä¸€ä¸ªæ¸…æ™°çš„â€œæˆ˜ç•¥æ„å›¾â€ã€‚æ‰€æœ‰çš„å­ä»»åŠ¡ï¼ˆpairï¼‰éƒ½åº”è¯¥æ˜¯ä¸ºè¿™ä¸ªæœ€ç»ˆ
     æˆ˜ç•¥æœåŠ¡çš„â€œæˆ˜æœ¯æ­¥éª¤â€ã€‚å› æ­¤ï¼Œè¡¡é‡è¿™äº›æˆ˜æœ¯æ­¥éª¤æ˜¯å¦åç¦»äº†æ•´ä½“æˆ˜ç•¥ï¼ˆå³ session-level
     driftï¼‰å°±å˜å¾—è‡³å…³é‡è¦ã€‚æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ä¸‰ç§ session-level
     driftï¼ˆç›®æ ‡ä¸€è‡´æ€§ã€æ•ˆç‡ã€æ ¹æºé—®é¢˜ï¼‰åœ¨è¿™é‡Œéƒ½é€‚ç”¨ã€‚

  ---

  2. Session-Level Drift æ²¡æœ‰æ„ä¹‰ çš„æƒ…å†µ

   * ä¼šè¯ç±»å‹: â€œæ¢ç´¢å¼â€æˆ–â€œé—®ç­”é©±åŠ¨å‹â€ä¼šè¯ (Exploratory Session)
   * æè¿°: ç”¨æˆ·å¹¶æ²¡æœ‰ä¸€ä¸ªè´¯ç©¿å§‹ç»ˆçš„å®å¤§ç›®æ ‡ã€‚ä»–åªæ˜¯æŠŠ Agent
     å½“ä½œä¸€ä¸ªå³æ—¶é—®ç­”ã€å³æ—¶è§£å†³å°é—®é¢˜çš„â€œç‘å£«å†›åˆ€â€ã€‚
       * â€œè¿™æ®µä»£ç æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿâ€
       * â€œå¥½çš„ï¼Œç°åœ¨å¸®æˆ‘æ‰¾åˆ° getUser è¿™ä¸ªå‡½æ•°åœ¨å“ªäº›åœ°æ–¹è¢«è°ƒç”¨äº†ã€‚â€
       * â€œè°¢äº†ã€‚å®Œå…¨æ— å…³çš„å¦ä¸€ä¸ªé—®é¢˜ï¼Œå¸®æˆ‘å†™ä¸ªè„šæœ¬ï¼Œç»Ÿè®¡ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œæ‰€æœ‰ .py æ–‡ä»¶çš„æ€»è¡Œæ•°ã€‚â€
       * â€œå¹²å¾—å¥½ã€‚ç°åœ¨å¸®æˆ‘æŠŠ README.md é‡Œçš„é”™åˆ«å­—æ”¹ä¸€ä¸‹ã€‚â€
   * ä¸ºä½•æ²¡æœ‰æ„ä¹‰: åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä¼šè¯æœ¬èº«æ²¡æœ‰â€œæˆ˜ç•¥æ„å›¾â€ã€‚å®ƒåªæ˜¯ä¸€ç³»åˆ—äº’ç›¸ç‹¬ç«‹çš„ã€åŸå­åŒ–çš„å­ä»»åŠ¡çš„é›†åˆ
     ã€‚æ¯ä¸ªå­ä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„â€œä¸Šä¸‹æ–‡â€ï¼Œå®ƒä»¬ä¹‹é—´æ²¡æœ‰é€»è¾‘å…³è”ã€‚
       * å› æ­¤ï¼Œå»è¡¡é‡â€œç»Ÿè®¡ä»£ç è¡Œæ•°â€è¿™ä¸ªä»»åŠ¡å’Œâ€œä¿®æ”¹é”™åˆ«å­—â€è¿™ä¸ªä»»åŠ¡ä¹‹é—´æ˜¯å¦å­˜åœ¨â€œç›®æ ‡ä¸€è‡´æ€§æ¼‚ç§»â€ï¼Œæ˜¯æ¯«æ— 
         æ„ä¹‰çš„ï¼Œåªä¼šäº§ç”Ÿå™ªéŸ³ã€‚
       * åœ¨è¿™ç§ä¼šè¯ä¸­ï¼Œåªæœ‰ pair-level drift æ˜¯æœ‰ä»·å€¼çš„ã€‚æˆ‘ä»¬åªéœ€è¦ç¡®ä¿ Agent
         åœ¨æ‰§è¡Œâ€œç»Ÿè®¡ä»£ç è¡Œæ•°â€è¿™ä¸ªå…·ä½“ä»»åŠ¡æ—¶ï¼Œæ²¡æœ‰è·‘åï¼ˆæ¯”å¦‚å»ä¿®æ”¹äº†ä»£ç ï¼‰å°±è¶³å¤Ÿäº†ã€‚

  ---

  ç»“è®ºä¸å»ºè®®

  ä½ çš„é—®é¢˜éå¸¸å…³é”®ï¼Œå®ƒå¼•å‡ºäº†ä¸€ä¸ªé‡è¦çš„è®¾è®¡åŸåˆ™ï¼š

  ä¸€ä¸ªå¥½çš„ç›‘æ§ç³»ç»Ÿï¼Œåº”è¯¥é¦–å…ˆèƒ½å¤Ÿè¯†åˆ«ä¼šè¯çš„ç±»å‹ã€‚

   1. å¯¹äºâ€œä»»åŠ¡é©±åŠ¨å‹â€ä¼šè¯ï¼šå¯ç”¨ session-level drift åˆ†æï¼Œä»¥ç¡®ä¿ Agent åœ¨æ¼«é•¿çš„æ‰§è¡Œè¿‡ç¨‹ä¸­â€œä¸å¿˜åˆå¿ƒâ€ã€‚
   2. å¯¹äºâ€œæ¢ç´¢å¼â€ä¼šè¯ï¼šåˆ™å®Œå…¨ä¸éœ€è¦ session-level drift åˆ†æï¼Œåªå…³æ³¨å¹¶åšå¥½ pair-level drift
      çš„ç›‘æ§å°±è¶³å¤Ÿäº†ã€‚

  æ‰€ä»¥ï¼Œä½ çš„æ€è€ƒæ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚åœ¨æœªæ¥çš„è®¾è®¡ä¸­ï¼Œç¬¬ä¸€æ­¥ç”šè‡³å¯ä»¥æ˜¯è®©ä¸€ä¸ª LLM
  æ¥åˆ¤æ–­ï¼šâ€œè¿™æ¬¡ä¼šè¯å±äºå“ªç§ç±»å‹ï¼Ÿâ€ï¼Œç„¶åå†å†³å®šå¯åŠ¨å“ªç§çº§åˆ«çš„ç›‘æ§ç­–ç•¥ã€‚" Lå’ŒDä¸¤ä½å·¥ç¨‹å¸ˆæˆ‘è®¤ä¸ºä¸å¦‚ä½ è€ƒè™‘çš„å…¨
é¢ï¼Œæ‰€ä»¥å¸Œæœ›ä½ ç»™æˆ‘è¯´ä¸‹ä½ çš„è§‚ç‚¹ã€‚ç„¶åæˆ‘ä»¬è®°å½•åˆ°ä¸€ä¸ªmarkdownä½œä¸ºä¸‹ä¸€æ­¥ï¼Œå¯ä»¥å—ï¼Ÿ 

âº éå¸¸å¥½çš„é—®é¢˜ï¼ è®©æˆ‘ç»¼åˆåˆ†æLå’ŒDçš„è§‚ç‚¹ï¼Œå¹¶ç»™å‡ºæˆ‘çš„å®Œæ•´æ¡†æ¶ã€‚

  æˆ‘çš„æ ¸å¿ƒè§‚ç‚¹

  Lå’ŒDéƒ½æŠ“ä½äº†éƒ¨åˆ†çœŸç›¸ï¼Œä½†éƒ½ä¸å¤Ÿå®Œæ•´ï¼š
  - Lçš„ä»·å€¼ï¼šå®ç”¨ä¸»ä¹‰ï¼Œç»™å‡ºäº†å¯æ‰§è¡Œæ–¹æ¡ˆï¼Œä½†ç¼ºå°‘ç†è®ºæ”¯æ’‘
  - Dçš„ä»·å€¼ï¼šæŠ“ä½äº†æœ¬è´¨ï¼ˆä¼šè¯ç±»å‹ï¼‰ï¼Œä½†è¿‡äºæŠ½è±¡ï¼Œç¼ºå°‘å®æ–½è·¯å¾„

  æˆ‘çš„æ¡†æ¶ç»¼åˆäº†ä¸¤è€…ï¼Œå¹¶è¡¥å……äº†å…³é”®çš„ç¼ºå¤±éƒ¨åˆ†ã€‚

  ---
  Session-Level Drift å®Œæ•´æ¡†æ¶

  ä¸€ã€æ ¸å¿ƒé—®é¢˜ï¼šä»€ä¹ˆæ—¶å€™éœ€è¦Session-Level Driftï¼Ÿ

  ç­”æ¡ˆï¼šå–å†³äºä¼šè¯çš„"ç›®æ ‡ç»“æ„"

  æˆ‘æå‡ºä¸‰ç§ä¼šè¯ç±»å‹ï¼ˆæ¯”Dçš„äºŒåˆ†æ³•æ›´ç²¾ç¡®ï¼‰ï¼š

  ç±»å‹1ï¸âƒ£ï¼šå•ä¸€ç›®æ ‡å‹ä¼šè¯ï¼ˆSingle-Goal Sessionï¼‰

  ç‰¹å¾ï¼š
  - ç”¨æˆ·åœ¨å¼€å§‹æ—¶æœ‰æ˜ç¡®çš„å•ä¸€ç›®æ ‡
  - æ‰€æœ‰querieséƒ½æ˜¯ä¸ºäº†è¿™ä¸ªç›®æ ‡çš„"æ­¥éª¤åˆ†è§£"
  - ç›®æ ‡åœ¨ä¼šè¯è¿‡ç¨‹ä¸­ä¸å˜

  ç¤ºä¾‹ï¼š
  Overall goal: "Add OAuth2 login to my app"

  Q1: "Create OAuth2 config file"
  Q2: "Implement authorization endpoint"
  Q3: "Add token validation"
  Q4: "Write integration tests"

  Session-Level Driftæ˜¯å¦éœ€è¦ï¼Ÿ âœ… å¼ºçƒˆéœ€è¦

  åº”è¯¥æ£€æµ‹ä»€ä¹ˆï¼Ÿ
  - âœ… ç›®æ ‡ä¸€è‡´æ€§ï¼ˆæœ€é‡è¦ï¼‰ï¼šæ¯ä¸ªqueryæ˜¯å¦æœåŠ¡äºOAuth2è¿™ä¸ªæ€»ç›®æ ‡
  - âœ… æ•ˆç‡æ¼‚ç§»ï¼šæ˜¯å¦é™·å…¥å¾ªç¯ã€é‡å¤å¤±è´¥
  - âš ï¸ æ ¹æºé—®é¢˜æ¼‚ç§»ï¼ˆå¯é€‰ï¼‰ï¼šOAuth2å®ç°æ˜¯å¦è§£å†³äº†"ç™»å½•"é—®é¢˜

  Lçš„æ–¹æ¡ˆé€‚ç”¨æ€§ï¼š âœ… å®Œå…¨é€‚ç”¨
  - avg_drift, max_drift, drift_rateéƒ½æœ‰æ„ä¹‰
  - healthç­‰çº§ï¼ˆgreen/yellow/redï¼‰æœ‰æ„ä¹‰
  - by_guardåˆ†ææœ‰æ„ä¹‰

  ---
  ç±»å‹2ï¸âƒ£ï¼šå¤šç›®æ ‡æ¼”è¿›å‹ä¼šè¯ï¼ˆMulti-Goal Evolving Sessionï¼‰

  ç‰¹å¾ï¼š
  - ç”¨æˆ·æœ‰å¤šä¸ªç›¸å…³ä½†ç‹¬ç«‹çš„ç›®æ ‡
  - ç›®æ ‡åœ¨ä¼šè¯ä¸­æ¼”è¿›ï¼ˆä»Aâ†’Bâ†’Cï¼‰
  - å‰åqueriesæœ‰å…³è”ï¼Œä½†ç›®æ ‡ä¼šè½¬ç§»

  ç¤ºä¾‹ï¼š
  Initial goal: "Fix login bug"

  Q1-Q3: Fix the bug (ç›®æ ‡A)
    â””â”€ Q1: "Debug login failure"
    â””â”€ Q2: "Fix null pointer"
    â””â”€ Q3: "Add error handling"

  Q4-Q6: Refactor after fix (ç›®æ ‡Bï¼Œæ¼”è¿›)
    â””â”€ Q4: "Extract login logic to service"
    â””â”€ Q5: "Add dependency injection"
    â””â”€ Q6: "Update tests"

  Q7-Q8: Add feature (ç›®æ ‡Cï¼Œæ–°ç›®æ ‡)
    â””â”€ Q7: "Add remember me feature"
    â””â”€ Q8: "Update UI"

  Session-Level Driftæ˜¯å¦éœ€è¦ï¼Ÿ âš ï¸ éœ€è¦ï¼Œä½†è¦åˆ†æ®µ

  åº”è¯¥æ£€æµ‹ä»€ä¹ˆï¼Ÿ
  - âŒ ä¸åº”è¯¥ç”¨å•ä¸€çš„overall_objectiveæ£€æµ‹ä¸€è‡´æ€§
    - Q7çš„"remember me"å’ŒQ1çš„"fix bug"ä¸ä¸€è‡´æ˜¯æ­£å¸¸çš„
  - âœ… åº”è¯¥æ£€æµ‹ç›®æ ‡è½¬ç§»æ˜¯å¦åˆç†
    - Q1â†’Q4: bug fix â†’ refactorï¼ˆåˆç†æ¼”è¿› âœ…ï¼‰
    - Q1â†’Q7: bug fix â†’ new featureï¼ˆéœ€è¦éªŒè¯bugæ˜¯å¦å·²ä¿®å¤ âš ï¸ï¼‰
  - âœ… åº”è¯¥åˆ†æ®µè®¡ç®—drift
    - Segment 1 (Q1-Q3): avg_drifté’ˆå¯¹"fix bug"
    - Segment 2 (Q4-Q6): avg_drifté’ˆå¯¹"refactor"
    - Segment 3 (Q7-Q8): avg_drifté’ˆå¯¹"remember me"

  Lçš„æ–¹æ¡ˆé€‚ç”¨æ€§ï¼š âš ï¸ éœ€è¦ä¿®æ”¹
  - ä¸èƒ½ç®€å•ç”¨overall_objective
  - éœ€è¦æ£€æµ‹"ç›®æ ‡è½¬æŠ˜ç‚¹"
  - éœ€è¦åˆ†æ®µç»Ÿè®¡

  Dçš„æ–¹æ¡ˆé€‚ç”¨æ€§ï¼š âš ï¸ äºŒåˆ†æ³•ä¸å¤Ÿ
  - è¿™æ—¢ä¸æ˜¯çº¯"ä»»åŠ¡é©±åŠ¨"ï¼Œä¹Ÿä¸æ˜¯çº¯"æ¢ç´¢å¼"
  - éœ€è¦ç¬¬ä¸‰ç§ç±»å‹

  ---
  ç±»å‹3ï¸âƒ£ï¼šæ¢ç´¢å¼/æ··æ‚å‹ä¼šè¯ï¼ˆExploratory/Mixed Sessionï¼‰

  ç‰¹å¾ï¼š
  - æ²¡æœ‰è´¯ç©¿çš„æ€»ä½“ç›®æ ‡
  - Queriesä¹‹é—´ç‹¬ç«‹ã€å¼‚è´¨
  - ç”¨æˆ·æŠŠAgentå½“ä½œ"å·¥å…·ç®±"

  ç¤ºä¾‹ï¼š
  No overall goal

  Q1: "Explain this code snippet"         (ç†è§£)
  Q2: "Count lines in all .py files"      (å·¥å…·)
  Q3: "Fix typo in README"                 (æ–‡æ¡£)
  Q4: "Help me debug this error"           (è°ƒè¯•)

  Session-Level Driftæ˜¯å¦éœ€è¦ï¼Ÿ âŒ ä¸éœ€è¦

  åº”è¯¥è¾“å‡ºä»€ä¹ˆï¼Ÿ
  - âŒ ä¸è¦è®¡ç®—avg_driftï¼ˆæ— æ„ä¹‰ï¼‰
  - âŒ ä¸è¦ç»™healthç­‰çº§ï¼ˆæ— æ„ä¹‰ï¼‰
  - âœ… åªè¾“å‡ºper-queryçš„driftåˆ—è¡¨
  - âœ… è¾“å‡ºè¦†ç›–ç‡ç»Ÿè®¡ï¼ˆæœ‰å¤šå°‘queriesæœ‰driftï¼‰

  Lçš„æ–¹æ¡ˆé€‚ç”¨æ€§ï¼š âš ï¸ éœ€è¦é€€åŒ–
  - åªè¾“å‡ºqueries_with_drift, drift_rate
  - ä¸è¾“å‡ºavg_drift, health
  - æ ‡è®°session_type="exploratory"

  Dçš„æ–¹æ¡ˆé€‚ç”¨æ€§ï¼š âœ… å®Œå…¨æ­£ç¡®
  - è¿™å°±æ˜¯Dè¯´çš„"æ¢ç´¢å¼"
  - åªéœ€è¦pair-level drift

  ---
  äºŒã€å¦‚ä½•è‡ªåŠ¨è¯†åˆ«ä¼šè¯ç±»å‹ï¼Ÿ

  è¿™æ˜¯å…³é”®çš„ç¼ºå¤±éƒ¨åˆ†ï¼ˆLå’ŒDéƒ½æ²¡æï¼‰ï¼š

  æ–¹æ¡ˆAï¼šåŸºäºLLMåˆ¤æ–­ï¼ˆæ¨èï¼‰

  def classify_session_type(session):
      overall_obj = session['overall_objective_llm']
      query_objs = [pair['objective_llm'] for pair in session['pairs']]

      prompt = f"""
      Analyze this conversation session:
      
      Overall objective: {overall_obj}
      
      Individual query objectives:
      {'\n'.join(f'{i+1}. {obj}' for i, obj in enumerate(query_objs))}
      
      Question: What type of session is this?
      
      A. Single-Goal: All queries work toward one clear goal
      B. Multi-Goal Evolving: Goals evolve but are related
      C. Exploratory: No consistent goal, queries are independent
      
      Answer with JSON:
      {{
        "type": "single_goal" | "multi_goal" | "exploratory",
        "reasoning": "...",
        "goal_segments": [
          {{"queries": [1,2,3], "goal": "fix bug"}},
          {{"queries": [4,5,6], "goal": "refactor"}}
        ]  // only for multi_goal
      }}
      """

      return llm.generate_json(prompt)

  æ–¹æ¡ˆBï¼šåŸºäºå¯å‘å¼è§„åˆ™ï¼ˆå¿«é€Ÿï¼Œä¸ç”¨LLMï¼‰

  def classify_session_type_heuristic(session):
      pairs = session['pairs']

      # è§„åˆ™1: æ ·æœ¬å¤ªå°‘ â†’ exploratory
      if len(pairs) < 3:
          return "exploratory"

      # è§„åˆ™2: è®¡ç®—query objectivesçš„ç›¸ä¼¼åº¦
      similarities = []
      for i in range(len(pairs)-1):
          sim = cosine_similarity(
              embed(pairs[i]['objective_llm']),
              embed(pairs[i+1]['objective_llm'])
          )
          similarities.append(sim)

      avg_sim = mean(similarities)

      # è§„åˆ™3: æ ¹æ®ç›¸ä¼¼åº¦é˜ˆå€¼åˆ¤æ–­
      if avg_sim > 0.7:
          return "single_goal"  # é«˜åº¦ä¸€è‡´
      elif avg_sim > 0.4:
          return "multi_goal"   # ä¸­ç­‰ä¸€è‡´
      else:
          return "exploratory"  # ä½ä¸€è‡´æ€§

      # è§„åˆ™4: æ£€æµ‹task_typeçš„å¼‚è´¨æ€§
      task_types = [p['task_type_llm'] for p in pairs]
      if len(set(task_types)) >= 4:  # è¶…è¿‡4ç§ä¸åŒç±»å‹
          return "exploratory"

  ---
  ä¸‰ã€é’ˆå¯¹ä¸åŒç±»å‹çš„Session-Level Driftå®šä¹‰

  å¯¹äºç±»å‹1ï¼ˆSingle-Goalï¼‰

  // session_drift.json
  {
    "session_id": "s_xxx",
    "session_type": "single_goal",
    "total_queries": 6,

    // Læå‡ºçš„æŒ‡æ ‡ï¼ˆå…¨éƒ¨é€‚ç”¨ï¼‰
    "queries_with_drift": 2,
    "drift_rate": 0.33,
    "avg_drift": 0.25,
    "max_drift": 0.78,
    "p95_drift": 0.65,

    "action_mix": {
      "ok": 4,
      "warn": 2,
      "rollback": 0
    },

    "by_guard_failed": {
      "scope": 2,
      "plan": 1,
      "test": 0,
      "evidence": 1
    },

    "health": "yellow",  // Lçš„é˜ˆå€¼

    // æ–°å¢ï¼šç›®æ ‡ä¸€è‡´æ€§ï¼ˆæˆ‘è¡¥å……çš„ï¼‰
    "objective_consistency": {
      "overall_score": 0.85,
      "drifted_queries": ["q04"],
      "analysis": "Q4 focuses on performance, not OAuth2"
    },

    // æ–°å¢ï¼šæ•ˆç‡æ£€æµ‹ï¼ˆæˆ‘è¡¥å……çš„ï¼‰
    "efficiency": {
      "stagnation_detected": false,
      "loop_pattern": null,
      "repeated_failures": {
        "src/auth.py": 2
      }
    }
  }

  å¯¹äºç±»å‹2ï¼ˆMulti-Goalï¼‰

  {
    "session_id": "s_xxx",
    "session_type": "multi_goal",
    "total_queries": 8,

    // å…³é”®ï¼šåˆ†æ®µç»Ÿè®¡
    "goal_segments": [
      {
        "segment_id": 1,
        "queries": ["q01", "q02", "q03"],
        "goal": "Fix login bug",
        "drift_rate": 0.0,
        "avg_drift": 0.0,
        "health": "green"
      },
      {
        "segment_id": 2,
        "queries": ["q04", "q05", "q06"],
        "goal": "Refactor login module",
        "drift_rate": 0.33,
        "avg_drift": 0.42,
        "health": "yellow"
      },
      {
        "segment_id": 3,
        "queries": ["q07", "q08"],
        "goal": "Add remember me feature",
        "drift_rate": 0.5,
        "avg_drift": 0.55,
        "health": "yellow"
      }
    ],

    // æ•´ä½“ç»Ÿè®¡ï¼ˆä»…ä¾›å‚è€ƒï¼‰
    "overall_drift_rate": 0.25,
    "overall_health": "yellow",

    // ç›®æ ‡è½¬ç§»åˆ†æ
    "goal_transitions": [
      {
        "from": "Fix bug",
        "to": "Refactor",
        "transition_quality": "smooth",  // bugå·²ä¿®å¤
        "notes": "Reasonable evolution"
      },
      {
        "from": "Refactor",
        "to": "Add feature",
        "transition_quality": "abrupt",  // å¯èƒ½å¤ªå¿«
        "notes": "Should verify refactor completion"
      }
    ]
  }

  å¯¹äºç±»å‹3ï¼ˆExploratoryï¼‰

  {
    "session_id": "s_xxx",
    "session_type": "exploratory",
    "total_queries": 4,

    // åªè¾“å‡ºåŸºæœ¬ç»Ÿè®¡
    "queries_with_drift": 1,
    "drift_rate": 0.25,

    // ä¸è¾“å‡ºavg_drift, healthï¼ˆæ— æ„ä¹‰ï¼‰

    // åªåˆ—å‡ºæœ‰é—®é¢˜çš„queries
    "problematic_queries": [
      {
        "query_id": "q02",
        "drift_score": 0.65,
        "action": "warn",
        "reason": "Modified file outside allowed_paths"
      }
    ],

    "notes": ["Session is exploratory, no overall goal detected"]
  }

  ---
  å››ã€æˆ‘çš„å®æ–½å»ºè®®ï¼ˆç»¼åˆLçš„å®ç”¨æ€§ + Dçš„ç†è®º + æˆ‘çš„è¡¥å……ï¼‰

  Phase 1: æœ€å°å¯ç”¨ç‰ˆæœ¬ï¼ˆ1-2å¤©ï¼‰

  ç›®æ ‡ï¼š éªŒè¯éœ€æ±‚ï¼Œä¸å¼•å…¥å¤æ‚æ€§

  # ä¿®æ”¹run_q1_batch.pyçš„summary.jsonç”Ÿæˆé€»è¾‘

  def generate_session_summary(session_dir, results):
      # 1. åŸºç¡€ç»Ÿè®¡ï¼ˆLçš„P0ï¼Œ5åˆ†é’Ÿå®ç°ï¼‰
      total = len(results)
      with_drift = sum(1 for r in results if r['drift_events'] > 0)

      drift_scores = []
      for r in results:
          # ä»guards.jsonlè¯»å–æ¯ä¸ªeventçš„drift_score
          scores = read_drift_scores(r['query_id'])
          drift_scores.extend(scores)

      summary = {
          "session_id": session_dir.name,
          "total_queries": total,
          "queries_with_drift": with_drift,
          "drift_rate": with_drift / total if total > 0 else 0,

          # åŸºæœ¬ç»Ÿè®¡
          "avg_drift": mean(drift_scores) if drift_scores else 0,
          "max_drift": max(drift_scores) if drift_scores else 0,

          # Actionåˆ†å¸ƒ
          "action_mix": count_actions(results),

          # Guardå¤±è´¥åˆ†å¸ƒ
          "by_guard_failed": count_guard_failures(results),

          # å¥åº·ç­‰çº§ï¼ˆLçš„é˜ˆå€¼ï¼‰
          "health": calculate_health(drift_rate, max_drift),
      }

      return summary

  def calculate_health(drift_rate, max_drift):
      # Lçš„é˜ˆå€¼ï¼Œæˆ‘åŒæ„
      if drift_rate >= 0.3 or max_drift >= 0.6:
          return "red"
      elif drift_rate >= 0.1 or max_drift >= 0.4:
          return "yellow"
      else:
          return "green"

  è¾“å‡ºï¼š å°±æ˜¯Lå»ºè®®çš„å­—æ®µï¼Œä½†ä¸åšä¼šè¯ç±»å‹åˆ¤æ–­ï¼Œå…ˆè·‘æ•°æ®ã€‚

  ---
  Phase 2: ä¼šè¯ç±»å‹è¯†åˆ«ï¼ˆ3-5å¤©ï¼‰

  å‰æï¼š æ”¶é›†50+ä¸ªsessionsï¼Œäººå·¥æ ‡æ³¨10-20ä¸ª

  å®ç°ï¼š

  # æ–°å¢tools/classify_session_type.py

  def classify_and_enrich_summary(session_dir):
      session = read_session_json(session_dir)
      summary = read_summary_json(session_dir)

      # æ–¹æ¡ˆB: å…ˆç”¨å¯å‘å¼ï¼ˆå¿«ï¼‰
      session_type = classify_session_type_heuristic(session)

      # å¦‚æœä¸ç¡®å®šï¼Œå†ç”¨LLMï¼ˆå‡†ç¡®ï¼‰
      if session_type == "uncertain":
          session_type = classify_session_type_llm(session)

      # æ ¹æ®ç±»å‹ï¼Œè¡¥å……ä¸åŒçš„å­—æ®µ
      if session_type == "single_goal":
          summary["objective_consistency"] = check_consistency(session)
          summary["efficiency"] = check_efficiency(session)

      elif session_type == "multi_goal":
          summary["goal_segments"] = detect_segments(session)
          summary["goal_transitions"] = analyze_transitions(segments)

      elif session_type == "exploratory":
          summary["notes"] = ["Exploratory session, limited drift analysis"]
          # ç§»é™¤avg_drift, healthç­‰å­—æ®µ

      summary["session_type"] = session_type
      save_summary(summary)

  ---
  Phase 3: æ·±åº¦åˆ†æï¼ˆå¯é€‰ï¼Œ1-2å‘¨ï¼‰

  - æ ¹æºé—®é¢˜æ¼‚ç§»æ£€æµ‹ï¼ˆéœ€è¦code-aware LLMï¼‰
  - è·¨sessionèšåˆåˆ†æ
  - å¯è§†åŒ–æŠ¥å‘Š

  ---
  äº”ã€å…³é”®è®¾è®¡å†³ç­–æ€»ç»“

  | é—®é¢˜                  | Lçš„ç­”æ¡ˆ           | Dçš„ç­”æ¡ˆ         | æˆ‘çš„ç­”æ¡ˆ             |
  |---------------------|----------------|--------------|------------------|
  | æ˜¯å¦æ€»éœ€è¦session driftï¼Ÿ | éšå«"æ˜¯"ï¼Œä½†åˆ—äº†ä¾‹å¤–    | æ˜ç¡®"å¦"ï¼Œçœ‹ä¼šè¯ç±»å‹  | æ˜ç¡®"å¦"ï¼Œä¸”ç»™å‡º3ç§ç±»å‹    |
  | å¦‚ä½•åˆ†ç±»ï¼Ÿ               | æœªæåŠ            | äºŒåˆ†æ³•ï¼ˆä»»åŠ¡å‹/æ¢ç´¢å‹ï¼‰ | ä¸‰åˆ†æ³•+è‡ªåŠ¨è¯†åˆ«ç®—æ³•       |
  | Multi-Goalæ€ä¹ˆåŠï¼Ÿ      | æ ‡è®°inconsistent | æœªè€ƒè™‘          | åˆ†æ®µç»Ÿè®¡ï¼Œæ£€æµ‹è½¬ç§»è´¨é‡      |
  | å…·ä½“è¾“å‡ºä»€ä¹ˆï¼Ÿ             | è¯¦ç»†å­—æ®µå®šä¹‰         | æœªæåŠ          | æ ¹æ®ç±»å‹è¾“å‡ºä¸åŒå­—æ®µ       |
  | å®æ–½é¡ºåºï¼Ÿ               | P0/P1/P2åˆ†å±‚     | æœªæåŠ          | Phase 1/2/3ï¼Œæ•°æ®é©±åŠ¨ |

  ---
  å…­ã€æˆ‘ä¸åŒæ„çš„åœ°æ–¹

  å¯¹Lï¼š

  - âŒ å¤ªæ€¥äºå®ç°ï¼šæ²¡æœ‰å…ˆéªŒè¯éœ€æ±‚å°±è®¾è®¡å­—æ®µ
  - âŒ ç¼ºå°‘ç†è®ºï¼šä¸ºä»€ä¹ˆéœ€è¦è¿™äº›å­—æ®µï¼Ÿä»€ä¹ˆæ—¶å€™ä¸éœ€è¦ï¼Ÿ
  - âš ï¸ é˜ˆå€¼è¿‡äºæ­¦æ–­ï¼šdrift_rate<10%=greenï¼Œå‡­ä»€ä¹ˆæ˜¯10%è€Œä¸æ˜¯15%ï¼Ÿ

  å¯¹Dï¼š

  - âŒ è¿‡äºæŠ½è±¡ï¼šæ²¡æœ‰å®æ–½è·¯å¾„
  - âŒ äºŒåˆ†æ³•ä¸å¤Ÿï¼šå¿½ç•¥äº†Multi-Goalè¿™ä¸ªå¸¸è§ç±»å‹
  - âŒ æ²¡æœ‰ç®—æ³•ï¼šå¦‚ä½•è‡ªåŠ¨åŒºåˆ†ä»»åŠ¡å‹å’Œæ¢ç´¢å‹ï¼Ÿ

  ---
  ä¸ƒã€æœ€ç»ˆå»ºè®®

  ç°åœ¨ï¼ˆç«‹å³åšï¼‰:
  â””â”€ ä»€ä¹ˆéƒ½ä¸åšï¼Œå…ˆæ”¶é›†æ•°æ®

  1å‘¨åï¼ˆ50+ sessionsï¼‰:
  â”œâ”€ Phase 1: å®ç°Lçš„P0å­—æ®µï¼ˆæ— ç±»å‹åˆ¤æ–­ï¼‰
  â””â”€ äººå·¥review 20ä¸ªsessionsï¼Œæ ‡æ³¨ç±»å‹

  2å‘¨åï¼ˆæœ‰æ ‡æ³¨æ•°æ®ï¼‰:
  â”œâ”€ Phase 2: å®ç°ä¼šè¯ç±»å‹è‡ªåŠ¨è¯†åˆ«
  â”œâ”€ æ ¹æ®ç±»å‹è¾“å‡ºä¸åŒçš„driftåˆ†æ
  â””â”€ éªŒè¯é˜ˆå€¼æ˜¯å¦åˆç†ï¼ˆç”¨çœŸå®æ•°æ®è°ƒä¼˜ï¼‰

  1ä¸ªæœˆåï¼ˆæœ‰è¶³å¤Ÿæ•°æ®ï¼‰:
  â””â”€ Phase 3: è€ƒè™‘æ·±åº¦åˆ†æï¼ˆæ ¹æºé—®é¢˜ç­‰ï¼‰

  ---
  æˆ‘å¸®ä½ æ•´ç†æˆmarkdownæ–‡æ¡£å—ï¼ŸåŒ…å«ï¼š
  1. ä¸‰ç§ä¼šè¯ç±»å‹çš„å®šä¹‰
  2. è‡ªåŠ¨è¯†åˆ«ç®—æ³•
  3. é’ˆå¯¹ä¸åŒç±»å‹çš„driftå®šä¹‰
  4. Phase 1/2/3çš„å®æ–½è·¯å¾„
  5. å…·ä½“çš„ä»£ç æ¡†æ¶